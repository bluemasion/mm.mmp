{% extends "base.html" %}

{% block title %}决策支持 - 物料主数据管理智能应用{% endblock %}

{% block extra_css %}
<style>
.decision-page {
    background-color: #f8f9fa;
    min-height: 100vh;
    padding: 20px 0;
}

.stats-card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: transform 0.2s ease;
    cursor: pointer;
    margin-bottom: 20px;
}

.stats-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.stats-card .card-body {
    padding: 1.5rem;
    text-align: center;
}

.stats-number {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.stats-label {
    font-size: 0.9rem;
    opacity: 0.8;
    margin-bottom: 0.5rem;
}

.progress-mini {
    height: 4px;
    border-radius: 2px;
    background: rgba(255,255,255,0.3);
}

.card-success {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
}

.card-warning {
    background: linear-gradient(135deg, #ffc107, #fd7e14);
    color: white;
}

.card-danger {
    background: linear-gradient(135deg, #dc3545, #e83e8c);
    color: white;
}

.card-info {
    background: linear-gradient(135deg, #17a2b8, #6f42c1);
    color: white;
}

.decision-section {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 30px;
    overflow: hidden;
}

.section-header {
    background: #f8f9fa;
    padding: 20px;
    border-bottom: 1px solid #dee2e6;
}

.section-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin: 0;
    color: #495057;
}

.recommendation-card {
    border-radius: 8px;
    transition: all 0.2s ease;
}

.recommendation-card:hover {
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.risk-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.detail-modal .modal-content {
    border-radius: 12px;
    border: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.detail-modal .modal-header {
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    border-radius: 12px 12px 0 0;
}

.data-table {
    margin-top: 20px;
}

.data-table th {
    background: #f8f9fa;
    font-weight: 600;
    border-bottom: 2px solid #dee2e6;
}

.confidence-bar {
    height: 6px;
    border-radius: 3px;
    background: #e9ecef;
    overflow: hidden;
}

.confidence-fill {
    height: 100%;
    transition: width 0.3s ease;
}

.action-buttons {
    padding: 20px;
    background: #f8f9fa;
    border-top: 1px solid #dee2e6;
}

.btn-action {
    border-radius: 8px;
    padding: 12px 24px;
    font-weight: 500;
    margin-right: 10px;
}

/* 简化的模态框样式 */
.detail-modal .modal-content {
    border-radius: 12px;
    border: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.detail-modal .modal-header {
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    border-radius: 12px 12px 0 0;
}

.confidence-bar {
    height: 8px;
    border-radius: 4px;
    background: #e9ecef;
    overflow: hidden;
}

.confidence-fill {
    height: 100%;
    transition: width 0.3s ease;
}

.floating-action {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 1000;
}

@media (max-width: 768px) {
    .stats-number {
        font-size: 2rem;
    }
    
    .floating-action {
        bottom: 20px;
        right: 20px;
    }
}

/* 模态框自定义样式 - 确保PC端有合适的大小 */
@media (min-width: 992px) {
    .detail-modal .modal-dialog {
        max-width: 90vw !important;
        width: 90vw !important;
        height: 90vh;
    }
    
    .detail-modal .modal-content {
        height: 90vh;
    }
    
    .detail-modal .modal-body {
        max-height: calc(90vh - 120px);
        overflow-y: auto;
    }
}

/* 确保模态框层级正确 */
.detail-modal {
    z-index: 1055 !important;
}

.detail-modal .modal-dialog {
    position: relative;
    z-index: 1060 !important;
}

.detail-modal .modal-content {
    position: relative;
    z-index: 1061 !important;
    background-color: white !important;
}

/* 确保模态框内的所有元素都可以点击 */
.detail-modal .modal-content * {
    position: relative;
    z-index: auto;
    pointer-events: auto !important;
}

/* 背景遮罩层级 */
.modal-backdrop {
    z-index: 1050 !important;
}

.modal-backdrop.show {
    opacity: 0.5;
}

/* 确保表格和按钮可以正常交互 */
.detail-modal .table,
.detail-modal .btn,
.detail-modal input[type="checkbox"],
.detail-modal .form-control,
.detail-modal .table-responsive,
.detail-modal tbody tr,
.detail-modal tbody td {
    pointer-events: auto !important;
    position: relative;
}

/* 确保模态框不被遮挡 */
.detail-modal .modal-dialog {
    margin: 1.75rem auto !important;
}

/* 防止背景影响点击 */
.detail-modal.show .modal-backdrop {
    pointer-events: none !important;
}

.detail-modal.show {
    pointer-events: auto !important;
}

/* 确保关闭按钮可以点击 */
.detail-modal .btn-close,
.detail-modal .modal-header button {
    pointer-events: auto !important;
    z-index: 1065 !important;
}
</style>
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="/upload">数据导入</a></li>
<li class="breadcrumb-item"><a href="/extract_parameters">参数提取</a></li>
<li class="breadcrumb-item"><a href="/categorize">类别选择</a></li>
<li class="breadcrumb-item"><a href="/form_generation">表单生成</a></li>
<li class="breadcrumb-item"><a href="/matching">智能匹配</a></li>
<li class="breadcrumb-item active">决策支持</li>
{% endblock %}

{% block content %}
<div class="decision-page">
    <div class="container-fluid">
        <!-- 统计概览卡片 -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="stats-card card-success" onclick="showMatchDetails('exact', 708)">
                    <div class="card-body">
                        <div class="stats-number">708</div>
                        <div class="stats-label">精确匹配</div>
                        <div class="progress-mini">
                            <div class="progress-bar" style="width: 85%; background: rgba(255,255,255,0.8);"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card card-warning" onclick="showMatchDetails('similar', 295)">
                    <div class="card-body">
                        <div class="stats-number">295</div>
                        <div class="stats-label">相似匹配</div>
                        <div class="progress-mini">
                            <div class="progress-bar" style="width: 70%; background: rgba(255,255,255,0.8);"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card card-danger" onclick="showMatchDetails('unmatched', 177)">
                    <div class="card-body">
                        <div class="stats-number">177</div>
                        <div class="stats-label">未匹配</div>
                        <div class="progress-mini">
                            <div class="progress-bar" style="width: 30%; background: rgba(255,255,255,0.8);"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card card-info">
                    <div class="card-body">
                        <div class="stats-number">85%</div>
                        <div class="stats-label">匹配成功率</div>
                        <div class="progress-mini">
                            <div class="progress-bar" style="width: 85%; background: rgba(255,255,255,0.8);"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- 左侧：决策建议 -->
            <div class="col-lg-8">
                <!-- 智能决策建议 -->
                <div class="decision-section">
                    <div class="section-header">
                        <h5 class="section-title">
                            <i class="fas fa-lightbulb text-primary"></i> 智能决策建议
                        </h5>
                    </div>
                    <div class="p-4">
                        <div class="row">
                            <!-- 自动处理建议 -->
                            <div class="col-md-6 mb-3">
                                <div class="recommendation-card border-success border-2 p-3">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="badge bg-success me-2">
                                            <i class="fas fa-check-circle"></i>
                                        </div>
                                        <h6 class="mb-0 text-success">建议自动处理</h6>
                                    </div>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span>精确匹配数据</span>
                                            <span class="badge bg-success">708 条</span>
                                        </div>
                                        <small class="text-muted">匹配度 ≥90%，可直接导入系统</small>
                                    </div>
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <div class="fw-bold text-success">15分钟</div>
                                            <small class="text-muted">预估时间</small>
                                        </div>
                                        <div class="col-6">
                                            <span class="risk-badge badge bg-success">低风险</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 人工审核建议 -->
                            <div class="col-md-6 mb-3">
                                <div class="recommendation-card border-warning border-2 p-3">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="badge bg-warning me-2">
                                            <i class="fas fa-exclamation-triangle"></i>
                                        </div>
                                        <h6 class="mb-0 text-warning">需要人工审核</h6>
                                    </div>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span>相似匹配数据</span>
                                            <span class="badge bg-warning">295 条</span>
                                        </div>
                                        <small class="text-muted">匹配度 60-89%，建议人工确认</small>
                                    </div>
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <div class="fw-bold text-warning">2-3小时</div>
                                            <small class="text-muted">预估时间</small>
                                        </div>
                                        <div class="col-6">
                                            <span class="risk-badge badge bg-warning">中风险</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 处理策略建议 -->
                <div class="decision-section">
                    <div class="section-header">
                        <h5 class="section-title">
                            <i class="fas fa-cogs text-primary"></i> 处理策略建议
                        </h5>
                    </div>
                    <div class="p-4">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="badge bg-primary me-3">
                                        <i class="fas fa-rocket"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">优先级策略</h6>
                                        <small class="text-muted">按匹配置信度排序处理</small>
                                    </div>
                                </div>
                                <ul class="list-unstyled ms-4">
                                    <li class="mb-2">
                                        <i class="fas fa-circle text-success me-2" style="font-size: 0.5rem;"></i>
                                        <span class="small">精确匹配：自动处理</span>
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-circle text-warning me-2" style="font-size: 0.5rem;"></i>
                                        <span class="small">相似匹配：人工审核</span>
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-circle text-danger me-2" style="font-size: 0.5rem;"></i>
                                        <span class="small">未匹配：手动处理</span>
                                    </li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="badge bg-info me-3">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">时间规划</h6>
                                        <small class="text-muted">总预估处理时间：3-4小时</small>
                                    </div>
                                </div>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-success" style="width: 60%"></div>
                                    <div class="progress-bar bg-warning" style="width: 25%"></div>
                                    <div class="progress-bar bg-danger" style="width: 15%"></div>
                                </div>
                                <div class="d-flex justify-content-between small text-muted">
                                    <span>自动(60%)</span>
                                    <span>审核(25%)</span>
                                    <span>手动(15%)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧：风险评估和策略对比 -->
            <div class="col-lg-4">
                <!-- 策略对比 -->
                <div class="decision-section">
                    <div class="section-header">
                        <h5 class="section-title">
                            <i class="fas fa-balance-scale text-primary"></i> 策略对比
                        </h5>
                    </div>
                    <div class="p-3">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>策略</th>
                                        <th>成功率</th>
                                        <th>人工成本</th>
                                        <th>预计时间</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="fw-bold">保守</td>
                                        <td>708</td>
                                        <td>472</td>
                                        <td class="text-warning">3-4小时</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold">平衡</td>
                                        <td>890</td>
                                        <td>290</td>
                                        <td class="text-success">2-3小时</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold">激进</td>
                                        <td>1003</td>
                                        <td>177</td>
                                        <td class="text-success">1-2小时</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 风险评估 -->
                <div class="decision-section">
                    <div class="section-header">
                        <h5 class="section-title">
                            <i class="fas fa-shield-alt text-primary"></i> 风险评估
                        </h5>
                    </div>
                    <div class="p-3">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small">数据质量风险</span>
                                <span class="badge bg-success">低</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-success" style="width: 25%"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small">匹配错误风险</span>
                                <span class="badge bg-warning">中</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-warning" style="width: 45%"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small">时间风险</span>
                                <span class="badge bg-success">低</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-success" style="width: 30%"></div>
                            </div>
                        </div>
                        
                        <div class="mt-4 p-3 bg-light rounded">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-info-circle text-info me-2"></i>
                                <small class="fw-bold">基于历史数据的风险评估</small>
                            </div>
                            <small class="text-muted">
                                根据相似项目的历史数据，当前处理策略的整体风险较低，建议采用平衡策略进行处理。
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 操作按钮区域 -->
        <div class="action-buttons text-center">
            <button type="button" class="btn btn-success btn-action btn-lg" onclick="executeAutoProcessing()">
                <i class="fas fa-play me-2"></i>开始自动处理
            </button>
            <button type="button" class="btn btn-warning btn-action btn-lg" onclick="startManualReview()">
                <i class="fas fa-user-check me-2"></i>人工审核
            </button>
            <button type="button" class="btn btn-secondary btn-action btn-lg" onclick="exportDecisionReport()">
                <i class="fas fa-download me-2"></i>导出报告
            </button>
        </div>
    </div>
</div>

<!-- 浮动操作按钮 -->
<div class="floating-action">
    <div class="btn-group-vertical">
        <button type="button" class="btn btn-primary rounded-pill mb-2" onclick="scrollToTop()">
            <i class="fas fa-arrow-up"></i>
        </button>
        <button type="button" class="btn btn-info rounded-pill" onclick="showHelpModal()">
            <i class="fas fa-question"></i>
        </button>
    </div>
</div>

<!-- 详情模态框 -->
<div class="modal fade detail-modal" id="matchDetailsModal" tabindex="-1" data-bs-backdrop="true" data-bs-keyboard="true">
    <div class="modal-dialog modal-fullscreen-lg-down modal-dialog-scrollable" style="max-width: 95vw;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="matchDetailsModalTitle">匹配详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="matchDetailsContent">
                    <!-- 动态内容将在这里加载 -->
                </div>
            </div>
            <div class="modal-footer">
                <div class="d-flex justify-content-between w-100 align-items-center">
                    <div>
                        <span id="modalRecordCount" class="text-muted">共 0 条记录</span>
                    </div>
                    <div>
                        <button type="button" class="btn btn-outline-success me-2" onclick="downloadCurrentData()">
                            <i class="fas fa-download me-1"></i>下载 CSV
                        </button>
                        <button type="button" class="btn btn-outline-primary me-2" onclick="processSelectedItems()">
                            <i class="fas fa-cogs me-1"></i>处理选中项目
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>关闭
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 帮助模态框 -->
<div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">决策支持帮助</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>功能说明：</h6>
                <ul>
                    <li><strong>精确匹配</strong>：相似度≥90%，建议自动处理</li>
                    <li><strong>相似匹配</strong>：相似度60-89%，需要人工审核</li>
                    <li><strong>未匹配</strong>：相似度<60%，需要手动处理</li>
                </ul>
                <h6>操作建议：</h6>
                <ul>
                    <li>点击统计卡片可查看详细数据</li>
                    <li>使用策略对比选择最适合的处理方案</li>
                    <li>关注风险评估结果，确保数据质量</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">了解了</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 页面加载完成后初始化
$(document).ready(function() {
    console.log('决策支持页面加载完成');
    
    // 添加卡片点击动画
    $('.stats-card').on('click', function() {
        $(this).addClass('animate__animated animate__pulse');
        setTimeout(() => {
            $(this).removeClass('animate__animated animate__pulse');
        }, 600);
    });
    
    // 初始化工具提示
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// 全局变量存储当前查看的数据
let currentModalData = {
    type: '',
    title: '',
    count: 0,
    data: []
};

// 显示匹配详情
function showMatchDetails(type, count) {
    let title, description, details;
    
    // 存储当前数据信息
    currentModalData.type = type;
    currentModalData.count = count;
    
    switch(type) {
        case 'exact':
            title = '精确匹配详情';
            description = `共有 ${count} 条数据实现了精确匹配，匹配度≥90%`;
            details = generateExactMatchDetails(count);
            currentModalData.title = title;
            currentModalData.data = generateExactMatchData(count);
            break;
        case 'similar':
            title = '相似匹配详情';
            description = `共有 ${count} 条数据为相似匹配，匹配度70%-90%`;
            details = generateSimilarMatchDetails(count);
            currentModalData.title = title;
            currentModalData.data = generateSimilarMatchData(count);
            break;
        case 'unmatched':
            title = '未匹配详情';
            description = `共有 ${count} 条数据未找到匹配，需要人工处理`;
            details = generateUnmatchedDetails(count);
            currentModalData.title = title;
            currentModalData.data = generateUnmatchedData(count);
            break;
    }
    
    // 设置模态框内容
    $('#matchDetailsModalTitle').text(title);
    $('#modalRecordCount').text(`共 ${count} 条记录`);
    $('#matchDetailsContent').html(`
        <p class="text-muted mb-3">${description}</p>
        ${details}
    `);
    
    // 显示模态框
    const modalElement = document.getElementById('matchDetailsModal');
    
    // 移除可能存在的旧实例
    const existingModal = bootstrap.Modal.getInstance(modalElement);
    if (existingModal) {
        existingModal.dispose();
    }
    
    // 创建新的模态框实例
    const modal = new bootstrap.Modal(modalElement, {
        backdrop: 'static',  // 改为static，防止点击背景关闭
        keyboard: true,
        focus: true
    });
    
    // 确保模态框内容可以交互
    modalElement.addEventListener('shown.bs.modal', function () {
        // 移除任何可能阻止点击的样式
        modalElement.style.pointerEvents = 'auto';
        const modalContent = modalElement.querySelector('.modal-content');
        if (modalContent) {
            modalContent.style.pointerEvents = 'auto';
            modalContent.style.zIndex = '1061';
        }
    });
    
    modal.show();
}

// 生成精确匹配详情
function generateExactMatchDetails(count) {
    let html = `
        <div class="table-responsive">
            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th><input type="checkbox" class="form-check-input" id="selectAll" onchange="toggleSelectAll()"></th>
                        <th>输入物料</th>
                        <th>匹配结果</th>
                        <th>匹配度</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    const materials = ['医用口罩', '一次性手套', '注射器', '输液器', '血压计', '体温计', '听诊器', '纱布', '绷带', '消毒液'];
    
    for(let i = 0; i < Math.min(count, 10); i++) {
        const material = materials[i % materials.length];
        const similarity = (90 + Math.random() * 10).toFixed(1);
        html += `
            <tr>
                <td><input type="checkbox" class="form-check-input row-checkbox"></td>
                <td>${material} ${i + 1}</td>
                <td>一次性医用${material}</td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="confidence-bar me-2" style="width: 60px; height: 8px; background: #e9ecef; border-radius: 4px;">
                            <div class="confidence-fill bg-success" style="width: ${similarity}%; height: 100%; border-radius: 4px;"></div>
                        </div>
                        <span class="small">${similarity}%</span>
                    </div>
                </td>
                <td><span class="badge bg-success">已确认</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewDetails(${i + 1})">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
        `;
    }
    
    if(count > 10) {
        html += `
            <tr>
                <td colspan="6" class="text-center text-muted py-3">
                    <i class="fas fa-ellipsis-h"></i> 还有 ${count - 10} 条记录... 
                    <button class="btn btn-link btn-sm ms-2" onclick="showAllRecords()">查看全部</button>
                </td>
            </tr>
        `;
    }
    
    html += '</tbody></table></div>';
    return html;
}

// 生成相似匹配详情
function generateSimilarMatchDetails(count) {
    let html = `
        <div class="table-responsive">
            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th><input type="checkbox" class="form-check-input" id="selectAll" onchange="toggleSelectAll()"></th>
                        <th>输入物料</th>
                        <th>匹配结果</th>
                        <th>匹配度</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    const materials = ['医用口罩', '一次性手套', '注射器', '输液器', '血压计', '体温计', '听诊器', '纱布', '绷带', '消毒液'];
    
    for(let i = 0; i < Math.min(count, 10); i++) {
        const material = materials[i % materials.length];
        const similarity = (70 + Math.random() * 20).toFixed(1);
        html += `
            <tr>
                <td><input type="checkbox" class="form-check-input row-checkbox"></td>
                <td>${material} ${i + 1}</td>
                <td>医用${material}(相似)</td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="confidence-bar me-2" style="width: 60px; height: 8px; background: #e9ecef; border-radius: 4px;">
                            <div class="confidence-fill bg-warning" style="width: ${similarity}%; height: 100%; border-radius: 4px;"></div>
                        </div>
                        <span class="small">${similarity}%</span>
                    </div>
                </td>
                <td><span class="badge bg-warning">待审核</span></td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-success" onclick="confirmMatch(${i + 1})" title="确认">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="rejectMatch(${i + 1})" title="拒绝">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }
    
    if(count > 10) {
        html += `
            <tr>
                <td colspan="6" class="text-center text-muted py-3">
                    <i class="fas fa-ellipsis-h"></i> 还有 ${count - 10} 条记录... 
                    <button class="btn btn-link btn-sm ms-2" onclick="showAllRecords()">查看全部</button>
                </td>
            </tr>
        `;
    }
    
    html += '</tbody></table></div>';
    return html;
}

// 生成未匹配详情
function generateUnmatchedDetails(count) {
    let html = `
        <div class="table-responsive">
            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th><input type="checkbox" class="form-check-input" id="selectAll" onchange="toggleSelectAll()"></th>
                        <th>输入物料</th>
                        <th>匹配结果</th>
                        <th>匹配度</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    const materials = ['特殊医疗设备', '进口医疗器械', '实验室设备', '专用医疗工具', '高端检测设备'];
    
    for(let i = 0; i < Math.min(count, 10); i++) {
        const material = materials[i % materials.length];
        html += `
            <tr>
                <td><input type="checkbox" class="form-check-input row-checkbox"></td>
                <td>${material} ${i + 1}</td>
                <td class="text-muted">无匹配结果</td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="confidence-bar me-2" style="width: 60px; height: 8px; background: #e9ecef; border-radius: 4px;">
                            <div class="confidence-fill bg-danger" style="width: 0%; height: 100%; border-radius: 4px;"></div>
                        </div>
                        <span class="small text-muted">0%</span>
                    </div>
                </td>
                <td><span class="badge bg-danger">无匹配</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="manualMatch(${i + 1})" title="手动匹配">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>
        `;
    }
    
    if(count > 10) {
        html += `
            <tr>
                <td colspan="6" class="text-center text-muted py-3">
                    <i class="fas fa-ellipsis-h"></i> 还有 ${count - 10} 条记录... 
                    <button class="btn btn-link btn-sm ms-2" onclick="showAllRecords()">查看全部</button>
                </td>
            </tr>
        `;
    }
    
    html += '</tbody></table></div>';
    return html;
}

// 全选切换
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.row-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

// 查看详情
function viewDetails(id) {
    alert(`查看物料 ${id} 的详细信息`);
}

// 确认匹配
function confirmMatch(id) {
    showSuccessMessage(`已确认匹配项目 ${id}`);
}

// 拒绝匹配
function rejectMatch(id) {
    showSuccessMessage(`已拒绝匹配项目 ${id}`);
}

// 手动匹配
function manualMatch(id) {
    showInfoMessage(`开始手动匹配项目 ${id}...`);
}

// 处理选中项目
function processSelectedItems() {
    const selectedItems = document.querySelectorAll('.row-checkbox:checked');
    if(selectedItems.length === 0) {
        alert('请先选择要处理的项目');
        return;
    }
    
    if(confirm(`确定要处理选中的 ${selectedItems.length} 个项目吗？`)) {
        // 这里添加实际的处理逻辑
        showSuccessMessage(`成功处理了 ${selectedItems.length} 个项目`);
        const modal = bootstrap.Modal.getInstance(document.getElementById('matchDetailsModal'));
        if (modal) modal.hide();
    }
}

// 显示全部记录
function showAllRecords() {
    // 动态从DOM中读取实际统计数据
    let exactCount = 708;   // 默认值
    let similarCount = 295; // 默认值  
    let unmatchedCount = 177; // 默认值
    
    // 尝试从统计卡片中获取实际数据
    try {
        const exactCard = document.querySelector('.card-success .stats-number');
        const similarCard = document.querySelector('.card-warning .stats-number');
        const unmatchedCard = document.querySelector('.card-danger .stats-number');
        
        if (exactCard) exactCount = parseInt(exactCard.textContent) || 708;
        if (similarCard) similarCount = parseInt(similarCard.textContent) || 295;
        if (unmatchedCard) unmatchedCount = parseInt(unmatchedCard.textContent) || 177;
    } catch (e) {
        console.log('使用默认统计数据');
    }
    
    // 生成所有类型的数据
    const exactMatches = generateExactMatchData(exactCount);  // 精确匹配数据
    const similarMatches = generateSimilarMatchData(similarCount);  // 相似匹配数据  
    const unmatched = generateUnmatchedData(unmatchedCount);  // 未匹配数据
    
    // 合并所有数据
    const allData = [];
    
    // 添加精确匹配数据
    exactMatches.forEach((item, index) => {
        allData.push({
            ...item,
            序号: allData.length + 1,
            匹配类型: '精确匹配'
        });
    });
    
    // 添加相似匹配数据
    similarMatches.forEach((item, index) => {
        allData.push({
            ...item,
            序号: allData.length + 1,
            匹配类型: '相似匹配'
        });
    });
    
    // 添加未匹配数据
    unmatched.forEach((item, index) => {
        allData.push({
            ...item,
            序号: allData.length + 1,
            匹配类型: '未匹配'
        });
    });
    
    // 存储数据到全局变量
    currentModalData = {
        title: '全部记录',
        data: allData
    };
    
    // 生成表格HTML
    let tableHtml = `
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th width="50">序号</th>
                        <th width="120">匹配类型</th>
                        <th width="150">输入物料</th>
                        <th width="150">匹配结果</th>
                        <th width="120">规格型号</th>
                        <th width="100">生产厂家</th>
                        <th width="80">匹配度</th>
                        <th width="80">状态</th>
                        <th width="80">分类</th>
                        <th width="100">创建时间</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    allData.forEach(item => {
        // 根据匹配类型设置状态样式
        let statusClass = 'text-muted';
        let typeClass = 'badge bg-secondary';
        
        if (item.匹配类型 === '精确匹配') {
            statusClass = 'text-success';
            typeClass = 'badge bg-success';
        } else if (item.匹配类型 === '相似匹配') {
            statusClass = 'text-warning';  
            typeClass = 'badge bg-warning';
        } else if (item.匹配类型 === '未匹配') {
            statusClass = 'text-danger';
            typeClass = 'badge bg-danger';
        }
        
        tableHtml += `
            <tr>
                <td>${item.序号}</td>
                <td><span class="${typeClass}">${item.匹配类型}</span></td>
                <td>${item.输入物料}</td>
                <td>${item.匹配结果}</td>
                <td>${item.规格型号}</td>
                <td>${item.生产厂家}</td>
                <td class="${statusClass}"><strong>${item.匹配度}</strong></td>
                <td><span class="badge ${item.状态 === '已确认' ? 'bg-success' : item.状态 === '待审核' ? 'bg-warning' : 'bg-secondary'}">${item.状态}</span></td>
                <td>${item.分类}</td>
                <td>${item.创建时间}</td>
            </tr>
        `;
    });
    
    tableHtml += `
                </tbody>
            </table>
        </div>
        <div class="mt-3 text-center">
            <p class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                共显示 ${allData.length} 条记录 
                (精确匹配: ${exactMatches.length}, 相似匹配: ${similarMatches.length}, 未匹配: ${unmatched.length})
            </p>
        </div>
    `;
    
    // 更新模态框内容
    $('#matchDetailsModalTitle').html('<i class="fas fa-list me-2"></i>全部记录');
    $('#matchDetailsContent').html(tableHtml);
    $('#modalRecordCount').text(`共 ${allData.length} 条记录`);
    
    // 显示模态框
    const modalElement = document.getElementById('matchDetailsModal');
    
    // 移除可能存在的旧实例
    const existingModal = bootstrap.Modal.getInstance(modalElement);
    if (existingModal) {
        existingModal.dispose();
    }
    
    // 创建新的模态框实例
    const modal = new bootstrap.Modal(modalElement, {
        backdrop: 'static',
        keyboard: true,
        focus: true
    });
    
    // 确保模态框内容可以交互
    modalElement.addEventListener('shown.bs.modal', function () {
        modalElement.style.pointerEvents = 'auto';
        const modalContent = modalElement.querySelector('.modal-content');
        if (modalContent) {
            modalContent.style.pointerEvents = 'auto';
            modalContent.style.zIndex = '1061';
        }
    });
    
    modal.show();
}

// 生成精确匹配数据（用于下载）
function generateExactMatchData(count) {
    const materials = ['医用口罩', '一次性手套', '注射器', '输液器', '血压计', '体温计', '听诊器', '纱布', '绷带', '消毒液'];
    const data = [];
    
    for(let i = 0; i < count; i++) {
        const material = materials[i % materials.length];
        const similarity = (90 + Math.random() * 10).toFixed(1);
        data.push({
            序号: i + 1,
            输入物料: `${material} ${i + 1}`,
            匹配结果: `一次性医用${material}`,
            规格型号: `标准规格 ${String.fromCharCode(65 + (i % 26))}`,
            生产厂家: `厂家${(i % 5) + 1}`,
            匹配度: `${similarity}%`,
            状态: '已确认',
            分类: '医疗器械',
            创建时间: new Date().toLocaleDateString()
        });
    }
    
    return data;
}

// 生成相似匹配数据（用于下载）
function generateSimilarMatchData(count) {
    const materials = ['医用口罩', '一次性手套', '注射器', '输液器', '血压计', '体温计', '听诊器', '纱布', '绷带', '消毒液'];
    const data = [];
    
    for(let i = 0; i < count; i++) {
        const material = materials[i % materials.length];
        const similarity = (70 + Math.random() * 20).toFixed(1);
        data.push({
            序号: i + 1,
            输入物料: `${material} ${i + 1}`,
            匹配结果: `医用${material}(相似)`,
            规格型号: `相似规格 ${String.fromCharCode(65 + (i % 26))}`,
            生产厂家: `厂家${(i % 8) + 1}`,
            匹配度: `${similarity}%`,
            状态: '待审核',
            分类: '医疗器械',
            创建时间: new Date().toLocaleDateString()
        });
    }
    
    return data;
}

// 生成未匹配数据（用于下载）
function generateUnmatchedData(count) {
    const materials = ['特殊医疗设备', '进口医疗器械', '实验室设备', '专用医疗工具', '高端检测设备'];
    const data = [];
    
    for(let i = 0; i < count; i++) {
        const material = materials[i % materials.length];
        data.push({
            序号: i + 1,
            输入物料: `${material} ${i + 1}`,
            匹配结果: '无匹配结果',
            规格型号: '规格未知',
            生产厂家: '厂家未知',
            匹配度: '0%',
            状态: '未匹配',
            分类: '未分类',
            创建时间: new Date().toLocaleDateString()
        });
    }
    
    return data;
}

// 下载当前数据为CSV
function downloadCurrentData() {
    if (!currentModalData.data || currentModalData.data.length === 0) {
        alert('没有可下载的数据');
        return;
    }
    
    // 生成CSV内容
    const headers = Object.keys(currentModalData.data[0]);
    let csvContent = headers.join(',') + '\n';
    
    currentModalData.data.forEach(row => {
        const values = headers.map(header => {
            let value = row[header] || '';
            // 处理包含逗号的值，用双引号包围
            if (value.toString().includes(',')) {
                value = `"${value}"`;
            }
            return value;
        });
        csvContent += values.join(',') + '\n';
    });
    
    // 添加BOM以支持中文
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
    
    // 创建下载链接
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    
    // 生成文件名
    const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
    const filename = `${currentModalData.title}_${timestamp}.csv`;
    link.setAttribute('download', filename);
    
    // 触发下载
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
        // 显示成功消息
    showSuccessMessage(`成功下载 ${currentModalData.data.length} 条记录到 ${filename}`);
}

// 显示成功消息
function showSuccessMessage(message) {
    const alertHtml = `
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    $('main .container-fluid').prepend(alertHtml);
    
    // 3秒后自动消失
    setTimeout(function() {
        $('.alert-success').fadeOut();
    }, 3000);
}

// 执行自动处理
function executeAutoProcessing() {
    if(confirm('确定要开始自动处理精确匹配的708条记录吗？')) {
        // 显示进度条
        showProcessingProgress('自动处理中...', 708);
    }
}

// 开始人工审核
function startManualReview() {
    if(confirm('确定要进入人工审核模式吗？')) {
        window.location.href = '/manual_review';
    }
}

// 导出决策报告
function exportDecisionReport() {
    // 生成报告数据
    const reportData = {
        timestamp: new Date().toISOString(),
        exact_matches: 708,
        similar_matches: 295,
        unmatched: 177,
        success_rate: 85
    };
    
    // 创建并下载CSV文件
    const csvContent = convertToCSV(reportData);
    downloadCSV(csvContent, `decision_report_${Date.now()}.csv`);
    
    showSuccessMessage('决策报告已导出');
}

// 显示处理进度
function showProcessingProgress(message, total) {
    const progressHtml = `
        <div class="alert alert-info">
            <h6>${message}</h6>
            <div class="progress mb-2">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     id="processingProgress" style="width: 0%"></div>
            </div>
            <div class="d-flex justify-content-between">
                <span id="progressText">准备中...</span>
                <span id="progressPercent">0%</span>
            </div>
        </div>
    `;
    
    $('main .container-fluid').prepend(progressHtml);
    
    // 模拟进度更新
    let progress = 0;
    const interval = setInterval(() => {
        progress += Math.random() * 15;
        if(progress >= 100) {
            progress = 100;
            clearInterval(interval);
            $('#progressText').text('处理完成！');
            setTimeout(() => {
                $('.alert-info').fadeOut();
                showSuccessMessage(`成功处理了 ${total} 条记录`);
            }, 1000);
        }
        
        $('#processingProgress').css('width', progress + '%');
        $('#progressPercent').text(Math.round(progress) + '%');
        $('#progressText').text(`正在处理... (${Math.round(progress * total / 100)}/${total})`);
    }, 500);
}

// 转换为CSV格式
function convertToCSV(data) {
    const headers = Object.keys(data).join(',');
    const values = Object.values(data).join(',');
    return headers + '\n' + values;
}

// 下载CSV文件
function downloadCSV(csvContent, filename) {
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

// 滚动到顶部
function scrollToTop() {
    $('html, body').animate({scrollTop: 0}, 800);
}

// 显示帮助模态框
function showHelpModal() {
    $('#helpModal').modal('show');
}

</script>
{% endblock %}