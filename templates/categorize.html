{% extends "base.html" %}

{% block title %}类别选择 - 物料主数据管理智能应用{% endblock %}

{% block extra_css %}
<style>
/* 统计模态框样式优化 */
#statsModal .modal-dialog {
    max-width: 95vw;
    width: 95vw;
    height: 95vh;
    margin: 1rem auto;
}

#statsModal .modal-content {
    height: 95vh;
    display: flex;
    flex-direction: column;
    pointer-events: auto;
    z-index: 1061;
    position: relative;
}

#statsModal .modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
    pointer-events: auto;
}

#statsModal .table-responsive {
    max-height: 60vh;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
}

/* 修复背景遮罩问题 */
.modal-backdrop {
    z-index: 1055 !important;
    pointer-events: none !important;
}

#statsModal {
    z-index: 1060 !important;
    pointer-events: auto !important;
}

#statsModal .modal-dialog {
    pointer-events: auto !important;
    z-index: 1061 !important;
}

#statsModal .modal-content {
    pointer-events: auto !important;
    z-index: 1062 !important;
    background: white !important;
}

#statsModal .modal-header,
#statsModal .modal-body,
#statsModal .modal-footer {
    pointer-events: auto !important;
    z-index: 1063 !important;
}

/* 统计卡片悬停效果 */
.stats-card {
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.stats-card:hover {
    transform: translateY(-5px) !important;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

/* 响应式设计 */
@media (max-width: 768px) {
    #statsModal .modal-dialog {
        width: 100vw;
        max-width: 100vw;
        height: 100vh;
        margin: 0;
    }
    
    #statsModal .modal-content {
        height: 100vh;
        border-radius: 0;
    }
}

/* PC端优化 */
@media (min-width: 992px) {
    #statsModal .modal-dialog {
        width: 90vw;
        height: 90vh;
    }
    
    #statsModal .modal-content {
        height: 90vh;
    }
}

/* 确保模态框内容可交互 */
#statsModal {
    pointer-events: auto;
}

#statsModal .modal-content {
    pointer-events: auto;
    z-index: 1061;
}
</style>
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="/upload">数据导入</a></li>
<li class="breadcrumb-item"><a href="/extract_parameters">参数提取</a></li>
<li class="breadcrumb-item active">类别选择</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-sitemap text-primary"></i> 类别选择与分类
                </h5>
            </div>
            <div class="card-body">
                <!-- 处理统计 -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white stats-card" data-type="total" style="cursor: pointer; transition: all 0.3s;">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <div class="h4 mb-0" id="totalCount">1,250</div>
                                        <div class="small">总记录数</div>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-database fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white stats-card" data-type="extracted" style="cursor: pointer; transition: all 0.3s;">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <div class="h4 mb-0" id="extractedCount">1,180</div>
                                        <div class="small">已提取参数</div>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-check-circle fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white stats-card" data-type="classified" style="cursor: pointer; transition: all 0.3s;">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <div class="h4 mb-0" id="classifiedCount">0</div>
                                        <div class="small">已分类</div>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-tags fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white stats-card" data-type="manual" style="cursor: pointer; transition: all 0.3s;">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <div class="h4 mb-0" id="manualCount">70</div>
                                        <div class="small">需人工确认</div>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 分类方式选择 -->
                <div class="mb-4">
                    <h6 class="fw-bold mb-3">分类方式</h6>
                    <div class="btn-group" role="group" aria-label="分类方式">
                        <input type="radio" class="btn-check" name="classifyMethod" id="autoClassify" value="auto" checked>
                        <label class="btn btn-outline-primary" for="autoClassify">
                            <i class="fas fa-magic"></i> 智能分类
                        </label>
                        
                        <input type="radio" class="btn-check" name="classifyMethod" id="manualClassify" value="manual">
                        <label class="btn btn-outline-secondary" for="manualClassify">
                            <i class="fas fa-hand-paper"></i> 手工分类
                        </label>
                        
                        <input type="radio" class="btn-check" name="classifyMethod" id="hybridClassify" value="hybrid">
                        <label class="btn btn-outline-success" for="hybridClassify">
                            <i class="fas fa-balance-scale"></i> 混合分类
                        </label>
                    </div>
                </div>

                <!-- 智能分类配置 -->
                <div id="autoClassifySection" class="classification-section">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card border-light">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">分类算法配置</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="classificationAlgorithm" class="form-label">算法类型</label>
                                        <select class="form-select" id="classificationAlgorithm">
                                            <option value="ml_classification" selected>机器学习分类</option>
                                            <option value="rule_based">基于规则</option>
                                            <option value="keyword_matching">关键词匹配</option>
                                            <option value="semantic_similarity">语义相似度</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="classificationConfidence" class="form-label">置信度阈值</label>
                                        <input type="range" class="form-range" id="classificationConfidence" 
                                               min="0.6" max="1.0" step="0.05" value="0.8">
                                        <div class="d-flex justify-content-between">
                                            <small>0.6</small>
                                            <small id="confidenceValueAuto">0.8</small>
                                            <small>1.0</small>
                                        </div>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="enableFuzzyMatching" checked>
                                        <label class="form-check-label" for="enableFuzzyMatching">
                                            启用模糊匹配
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-light">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">目标分类体系</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="classificationSystem" class="form-label">分类标准</label>
                                        <select class="form-select" id="classificationSystem">
                                            <option value="medical_device" selected>医疗器械分类</option>
                                            <option value="drug_classification">药品分类</option>
                                            <option value="consumables">医用耗材分类</option>
                                            <option value="custom">自定义分类</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="classificationLevel" class="form-label">分类层级</label>
                                        <select class="form-select" id="classificationLevel">
                                            <option value="1">一级分类</option>
                                            <option value="2" selected>二级分类</option>
                                            <option value="3">三级分类</option>
                                        </select>
                                    </div>
                                    <button type="button" class="btn btn-outline-info btn-sm" onclick="previewClassificationTree()">
                                        <i class="fas fa-tree"></i> 预览分类树
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 手工分类配置 -->
                <div id="manualClassifySection" class="classification-section d-none">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        手工分类模式下，您需要为每个物料手动选择类别。系统会提供分类建议供参考。
                    </div>
                    <div class="mb-3">
                        <label for="batchSize" class="form-label">每页显示数量</label>
                        <select class="form-select" id="batchSize" style="width: 200px;">
                            <option value="20" selected>20 条</option>
                            <option value="50">50 条</option>
                            <option value="100">100 条</option>
                        </select>
                    </div>
                </div>

                <!-- 混合分类配置 -->
                <div id="hybridClassifySection" class="classification-section d-none">
                    <div class="alert alert-success">
                        <i class="fas fa-lightbulb"></i> 
                        混合分类结合了智能分类和人工审核的优势，系统自动分类后，低置信度的结果将提交人工确认。
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="autoThreshold" class="form-label">自动分类阈值</label>
                                <input type="range" class="form-range" id="autoThreshold" 
                                       min="0.7" max="0.95" step="0.05" value="0.85">
                                <div class="d-flex justify-content-between">
                                    <small>0.7</small>
                                    <small id="autoThresholdValue">0.85</small>
                                    <small>0.95</small>
                                </div>
                                <small class="text-muted">高于此阈值的分类结果将自动确认</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="manualThreshold" class="form-label">人工确认阈值</label>
                                <input type="range" class="form-range" id="manualThreshold" 
                                       min="0.5" max="0.8" step="0.05" value="0.65">
                                <div class="d-flex justify-content-between">
                                    <small>0.5</small>
                                    <small id="manualThresholdValue">0.65</small>
                                    <small>0.8</small>
                                </div>
                                <small class="text-muted">低于此阈值的结果需要人工确认</small>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- 智能推荐结果展示 -->
                {% if material_recommendations %}
                <div id="smartRecommendations" class="mb-4">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-brain text-success"></i> 智能分类推荐
                        <span class="badge bg-success ms-2">{{ material_recommendations|length }} 个物料</span>
                    </h6>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        基于外部主数据平台的分类体系，为您的物料推荐最匹配的分类。请确认或调整推荐结果。
                    </div>

                    {% for item in material_recommendations %}
                    <div class="card mb-3 recommendation-card">
                        <div class="card-header bg-light">
                            <div class="row align-items-center">
                                <div class="col">
                                    <h6 class="mb-0">
                                        {{ item.material.get('物料名称', item.material.get('extracted_product_name', item.material.get('original_product_name', 'N/A'))) }}
                                    </h6>
                                    <small class="text-muted">
                                        规格：{{ item.material.get('规格', item.material.get('extracted_spec_model', item.material.get('original_spec_model', 'N/A'))) }} | 
                                        品牌：{{ item.material.get('品牌', 'N/A') }} |
                                        置信度：{{ "%.2f"|format(item.material.get('confidence', 0)) }}
                                    </small>
                                </div>
                                <div class="col-auto">
                                    <span class="badge bg-primary">{{ item.recommendations|length }} 个推荐</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% for recommendation in item.recommendations %}
                                <div class="col-md-6 mb-3">
                                    <div class="border rounded p-3 recommendation-option" 
                                         data-category-id="{{ recommendation.category_id }}"
                                         style="cursor: pointer; transition: all 0.3s;">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="mb-1">{{ recommendation.category_name }}</h6>
                                            <span class="badge bg-success">{{ "%.1f"|format(recommendation.confidence * 100) }}%</span>
                                        </div>
                                        <div class="progress mb-2" style="height: 4px;">
                                            <div class="progress-bar bg-success" 
                                                 style="width: {{ recommendation.confidence * 100 }}%"></div>
                                        </div>
                                        <div class="small text-muted">
                                            <strong>匹配原因：</strong>
                                            {% for reason in recommendation.match_reasons %}
                                            <span class="badge bg-light text-dark me-1">{{ reason }}</span>
                                            {% endfor %}
                                        </div>
                                        <div class="mt-2">
                                            <button type="button" class="btn btn-outline-primary btn-sm" 
                                                    onclick="selectRecommendation('{{ item.material.get('物料名称', item.material.get('extracted_product_name', item.material.get('original_product_name', ''))) }}', '{{ recommendation.category_id }}', '{{ recommendation.category_name }}')">
                                                <i class="fas fa-check"></i> 选择此分类
                                            </button>
                                            <button type="button" class="btn btn-outline-info btn-sm" 
                                                    onclick="viewCategoryFeatures('{{ recommendation.category_id }}')">
                                                <i class="fas fa-info"></i> 查看特征
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            {% if item.recommendations|length == 0 %}
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-search fa-2x mb-2"></i>
                                <p>暂无推荐分类，请手动选择或联系管理员</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- 分类预览 -->
                <div id="classificationPreview" class="mb-4 d-none">
                    <h6 class="fw-bold mb-3">分类预览</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover" id="classificationTable">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" class="form-check-input" id="selectAll">
                                    </th>
                                    <th>物料名称</th>
                                    <th>规格型号</th>
                                    <th>推荐分类</th>
                                    <th>置信度</th>
                                    <th style="width: 100px;">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">显示 1-20 条，共 1,180 条记录</small>
                        </div>
                        <nav>
                            <ul class="pagination pagination-sm mb-0">
                                <li class="page-item disabled">
                                    <a class="page-link" href="#">上一页</a>
                                </li>
                                <li class="page-item active">
                                    <a class="page-link" href="#">1</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="#">2</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="#">3</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="#">下一页</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-secondary" onclick="history.back()">
                        <i class="fas fa-arrow-left"></i> 上一步
                    </button>
                    <div>
                        <button type="button" class="btn btn-outline-primary me-2" onclick="previewClassification()">
                            <i class="fas fa-eye"></i> 预览分类
                        </button>
                        <button type="button" class="btn btn-primary" onclick="startClassification()">
                            <i class="fas fa-play"></i> 开始分类
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 右侧信息 -->
    <div class="col-lg-4">
        <!-- 分类进度 -->
        <div class="card shadow-sm mb-4" id="classificationProgress" style="display: none;">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie text-info"></i> 分类进度
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>总体进度</span>
                        <span id="classifyProgressPercent">0%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar bg-success" id="autoClassifiedBar" style="width: 0%"></div>
                        <div class="progress-bar bg-warning" id="manualReviewBar" style="width: 0%"></div>
                        <div class="progress-bar bg-danger" id="failedClassificationBar" style="width: 0%"></div>
                    </div>
                    <div class="small mt-1">
                        <span class="badge bg-success">自动分类</span>
                        <span class="badge bg-warning">待审核</span>
                        <span class="badge bg-danger">分类失败</span>
                    </div>
                </div>
                <div class="row text-center">
                    <div class="col-4">
                        <div class="h6 text-success mb-0" id="autoCount">0</div>
                        <div class="small text-muted">自动分类</div>
                    </div>
                    <div class="col-4">
                        <div class="h6 text-warning mb-0" id="reviewCount">0</div>
                        <div class="small text-muted">待审核</div>
                    </div>
                    <div class="col-4">
                        <div class="h6 text-danger mb-0" id="failedCount">0</div>
                        <div class="small text-muted">失败</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 分类统计 -->
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar text-success"></i> 分类统计
                </h5>
            </div>
            <div class="card-body">
                <div id="categoryStats">
                    <p class="text-muted text-center">开始分类后显示统计信息</p>
                </div>
            </div>
        </div>
        
        <!-- 分类说明 -->
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle text-info"></i> 分类说明
                </h5>
            </div>
            <div class="card-body">
                <div class="accordion" id="classifyHelpAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="autoClassifyHelp">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#autoClassifyHelpContent">
                                智能分类
                            </button>
                        </h2>
                        <div id="autoClassifyHelpContent" class="accordion-collapse collapse show" 
                             data-bs-parent="#classifyHelpAccordion">
                            <div class="accordion-body">
                                <ul class="list-unstyled small">
                                    <li><i class="fas fa-check text-success"></i> 基于机器学习算法</li>
                                    <li><i class="fas fa-check text-success"></i> 支持多种分类标准</li>
                                    <li><i class="fas fa-check text-success"></i> 自动处理大批量数据</li>
                                    <li><i class="fas fa-info-circle text-info"></i> 建议置信度 ≥ 0.8</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="hybridClassifyHelp">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#hybridClassifyHelpContent">
                                混合分类
                            </button>
                        </h2>
                        <div id="hybridClassifyHelpContent" class="accordion-collapse collapse" 
                             data-bs-parent="#classifyHelpAccordion">
                            <div class="accordion-body">
                                <ul class="list-unstyled small">
                                    <li><i class="fas fa-magic text-primary"></i> 高置信度自动分类</li>
                                    <li><i class="fas fa-user text-warning"></i> 低置信度人工确认</li>
                                    <li><i class="fas fa-balance-scale text-success"></i> 平衡效率与准确性</li>
                                    <li><i class="fas fa-info-circle text-info"></i> 推荐用于重要数据</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="manualClassifyHelp">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#manualClassifyHelpContent">
                                手工分类
                            </button>
                        </h2>
                        <div id="manualClassifyHelpContent" class="accordion-collapse collapse" 
                             data-bs-parent="#classifyHelpAccordion">
                            <div class="accordion-body">
                                <ul class="list-unstyled small">
                                    <li><i class="fas fa-hand-paper text-secondary"></i> 完全人工控制</li>
                                    <li><i class="fas fa-lightbulb text-warning"></i> 提供分类建议</li>
                                    <li><i class="fas fa-clock text-info"></i> 适合小批量精确处理</li>
                                    <li><i class="fas fa-shield-alt text-success"></i> 保证分类准确性</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 分类树预览模态框 -->
<div class="modal fade" id="classificationTreeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">分类体系预览</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="classificationTree"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 分类详情模态框 -->
<div class="modal fade" id="classificationDetailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">分类详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong>物料名称：</strong><span id="detailAssetName"></span>
                </div>
                <div class="mb-3">
                    <strong>规格型号：</strong><span id="detailSpecModel"></span>
                </div>
                <div class="mb-3">
                    <strong>当前分类：</strong>
                    <select class="form-select" id="detailCategory">
                        <!-- 动态选项 -->
                    </select>
                </div>
                <div class="mb-3">
                    <strong>推荐分类：</strong>
                    <div id="recommendedCategories"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveClassification()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 统计数据查看模态框 -->
<div class="modal fade" id="statsModal" tabindex="-1" aria-labelledby="statsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-lg-down">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title" id="statsModalLabel">
                    <i class="fas fa-chart-bar"></i> <span id="modalTitle">数据详情</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 搜索和过滤区 -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="recordSearch" placeholder="搜索物料名称或规格...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="statusFilter">
                            <option value="">全部状态</option>
                            <option value="pending">待处理</option>
                            <option value="processed">已处理</option>
                            <option value="error">错误</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-success" onclick="downloadStatsData()">
                            <i class="fas fa-download"></i> 下载CSV
                        </button>
                    </div>
                </div>

                <!-- 数据表格 -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>序号</th>
                                <th>物料名称</th>
                                <th>规格型号</th>
                                <th>状态</th>
                                <th>处理时间</th>
                                <th>备注</th>
                            </tr>
                        </thead>
                        <tbody id="statsTableBody">
                            <!-- 动态加载数据 -->
                        </tbody>
                    </table>
                </div>

                <!-- 分页 -->
                <nav aria-label="数据分页">
                    <ul class="pagination justify-content-center" id="statsPagination">
                        <!-- 动态生成分页 -->
                    </ul>
                </nav>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let classificationConfig = {};
let currentClassificationData = [];

$(document).ready(function() {
    // 统计卡片点击事件
    $('.stats-card').click(function() {
        const type = $(this).data('type');
        showStatsModal(type);
    });

    // 统计卡片悬停效果
    $('.stats-card').hover(
        function() {
            $(this).css('transform', 'translateY(-5px)');
            $(this).css('box-shadow', '0 8px 25px rgba(0,0,0,0.15)');
        },
        function() {
            $(this).css('transform', 'translateY(0)');
            $(this).css('box-shadow', '0 2px 10px rgba(0,0,0,0.1)');
        }
    );

    // 分类方式切换
    $('input[name="classifyMethod"]').change(function() {
        $('.classification-section').addClass('d-none');
        $('#' + $(this).val() + 'ClassifySection').removeClass('d-none');
    });
    
    // 阈值变化监听
    $('#classificationConfidence').on('input', function() {
        $('#confidenceValueAuto').text($(this).val());
    });
    
    $('#autoThreshold').on('input', function() {
        $('#autoThresholdValue').text($(this).val());
    });
    
    $('#manualThreshold').on('input', function() {
        $('#manualThresholdValue').text($(this).val());
    });
    
    // 全选功能
    $('#selectAll').change(function() {
        $('#classificationTable tbody input[type="checkbox"]').prop('checked', $(this).is(':checked'));
    });
});

function previewClassificationTree() {
    const system = $('#classificationSystem').val();
    const level = $('#classificationLevel').val();
    
    showLoading('正在加载分类体系...');
    
    setTimeout(function() {
        hideLoading();
        
        const treeData = generateClassificationTree(system, level);
        displayClassificationTree(treeData);
        
        $('#classificationTreeModal').modal('show');
    }, 1000);
}

function generateClassificationTree(system, level) {
    const trees = {
        'medical_device': {
            '1': ['一类医疗器械', '二类医疗器械', '三类医疗器械'],
            '2': [
                '一类医疗器械 > 基础医疗器械',
                '一类医疗器械 > 康复器械',
                '二类医疗器械 > 诊断器械',
                '二类医疗器械 > 治疗器械',
                '三类医疗器械 > 植入器械',
                '三类医疗器械 > 生命支持器械'
            ]
        },
        'drug_classification': {
            '1': ['化学药品', '中药材', '生物制品'],
            '2': [
                '化学药品 > 抗感染药',
                '化学药品 > 心血管药',
                '中药材 > 清热药',
                '中药材 > 补益药',
                '生物制品 > 疫苗',
                '生物制品 > 血液制品'
            ]
        }
    };
    
    return trees[system] ? trees[system][level] : ['分类1', '分类2', '分类3'];
}

function displayClassificationTree(categories) {
    let treeHtml = '<ul class="list-group">';
    categories.forEach(function(category) {
        treeHtml += `<li class="list-group-item">${category}</li>`;
    });
    treeHtml += '</ul>';
    
    $('#classificationTree').html(treeHtml);
}

function previewClassification() {
    collectClassificationConfig();
    
    showLoading('正在生成分类预览...');
    
    setTimeout(function() {
        hideLoading();
        
        const previewData = generateClassificationPreview();
        displayClassificationPreview(previewData);
        
        $('#classificationPreview').removeClass('d-none');
        
        $('html, body').animate({
            scrollTop: $('#classificationPreview').offset().top - 100
        }, 500);
    }, 2000);
}

function collectClassificationConfig() {
    const method = $('input[name="classifyMethod"]:checked').val();
    
    classificationConfig = {
        method: method,
        algorithm: $('#classificationAlgorithm').val(),
        confidence_threshold: parseFloat($('#classificationConfidence').val()),
        classification_system: $('#classificationSystem').val(),
        classification_level: parseInt($('#classificationLevel').val()),
        enable_fuzzy_matching: $('#enableFuzzyMatching').is(':checked')
    };
    
    if (method === 'hybrid') {
        classificationConfig.auto_threshold = parseFloat($('#autoThreshold').val());
        classificationConfig.manual_threshold = parseFloat($('#manualThreshold').val());
    }
}

function generateClassificationPreview() {
    const sampleData = [
        {
            id: 1,
            asset_name: '阿莫西林胶囊',
            spec_model: '0.25g×24粒',
            recommended_category: '化学药品 > 抗感染药',
            confidence: 0.95,
            status: 'auto'
        },
        {
            id: 2,
            asset_name: '血压计',
            spec_model: '电子式',
            recommended_category: '二类医疗器械 > 诊断器械',
            confidence: 0.88,
            status: 'auto'
        },
        {
            id: 3,
            asset_name: '胰岛素注射液',
            spec_model: '10ml',
            recommended_category: '生物制品 > 激素类',
            confidence: 0.72,
            status: 'review'
        },
        {
            id: 4,
            asset_name: '医用棉签',
            spec_model: '无菌型',
            recommended_category: '一类医疗器械 > 基础医疗器械',
            confidence: 0.91,
            status: 'auto'
        },
        {
            id: 5,
            asset_name: '心电图机',
            spec_model: '12导联',
            recommended_category: '二类医疗器械 > 诊断器械',
            confidence: 0.65,
            status: 'review'
        }
    ];
    
    return sampleData;
}

function displayClassificationPreview(data) {
    let tableHtml = '';
    
    data.forEach(function(item) {
        const confidenceBadge = item.confidence >= 0.85 ? 'bg-success' : 
                               item.confidence >= 0.7 ? 'bg-warning' : 'bg-danger';
        const statusBadge = item.status === 'auto' ? 'bg-success' : 'bg-warning';
        const statusText = item.status === 'auto' ? '自动分类' : '待审核';
        
        tableHtml += `
            <tr>
                <td>
                    <input type="checkbox" class="form-check-input" value="${item.id}">
                </td>
                <td>${item.asset_name}</td>
                <td>${item.spec_model}</td>
                <td>
                    ${item.recommended_category}
                    <br><span class="badge ${statusBadge}">${statusText}</span>
                </td>
                <td>
                    <span class="badge ${confidenceBadge}">
                        ${(item.confidence * 100).toFixed(1)}%
                    </span>
                </td>
                <td>
                    <button class="btn btn-outline-primary btn-sm" onclick="editClassification(${item.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    $('#classificationTable tbody').html(tableHtml);
    currentClassificationData = data;
}

function editClassification(id) {
    const item = currentClassificationData.find(item => item.id === id);
    if (!item) return;
    
    $('#detailAssetName').text(item.asset_name);
    $('#detailSpecModel').text(item.spec_model);
    
    // 填充分类选项
    const categories = generateClassificationTree(
        $('#classificationSystem').val(),
        $('#classificationLevel').val()
    );
    
    let optionsHtml = '';
    categories.forEach(function(category) {
        const selected = category === item.recommended_category ? 'selected' : '';
        optionsHtml += `<option value="${category}" ${selected}>${category}</option>`;
    });
    $('#detailCategory').html(optionsHtml);
    
    // 显示推荐分类
    let recommendedHtml = `
        <div class="d-flex justify-content-between align-items-center">
            <span>${item.recommended_category}</span>
            <span class="badge bg-primary">${(item.confidence * 100).toFixed(1)}%</span>
        </div>
    `;
    $('#recommendedCategories').html(recommendedHtml);
    
    $('#classificationDetailModal').modal('show');
}

function saveClassification() {
    showSuccessMessage('分类修改已保存');
    $('#classificationDetailModal').modal('hide');
}

function startClassification() {
    collectClassificationConfig();
    
    // 显示进度卡片
    $('#classificationProgress').show();
    
    // 开始分类进程
    simulateClassification();
}

function simulateClassification() {
    const totalRecords = 1180;
    let processed = 0;
    let autoClassified = 0;
    let needReview = 0;
    let failed = 0;
    
    const interval = setInterval(function() {
        const batchSize = Math.floor(Math.random() * 30) + 20;
        processed += batchSize;
        
        // 模拟分类结果分布
        const autoBatch = Math.floor(batchSize * 0.75);
        const reviewBatch = Math.floor(batchSize * 0.2);
        const failedBatch = batchSize - autoBatch - reviewBatch;
        
        autoClassified += autoBatch;
        needReview += reviewBatch;
        failed += failedBatch;
        
        if (processed >= totalRecords) {
            processed = totalRecords;
            clearInterval(interval);
            
            setTimeout(function() {
                // 保存分类选择结果到会话
                saveCategorySelections(autoClassified, needReview, failed);
                showSuccessMessage('分类完成！');
                updateCategoryStats();
                setTimeout(function() {
                    window.location.href = '/form_generation';
                }, 2000);
            }, 1000);
        }
        
        updateClassificationProgress(processed, totalRecords, autoClassified, needReview, failed);
        
    }, 300);
}

function saveCategorySelections(autoClassified, needReview, failed) {
    // 生成模拟的分类选择数据
    const categorySelections = {
        auto_classified: autoClassified,
        need_review: needReview,
        failed: failed,
        method: $('#algorithmType').val() || '机器学习分类',
        confidence_threshold: parseFloat($('#confidenceThreshold').val()) || 0.8,
        classification_standard: $('#classificationStandard').val() || '医疗器械分类',
        classification_level: $('#classificationLevel').val() || '二级分类'
    };
    
    // 通过AJAX保存到会话
    $.ajax({
        url: '/save_category_selections',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            selections: categorySelections,
            total_classified: autoClassified + needReview,
            total_failed: failed
        }),
        success: function(response) {
            console.log('分类选择已保存到会话');
        },
        error: function(xhr, status, error) {
            console.error('保存分类选择失败:', error);
        }
    });
}

function updateClassificationProgress(processed, total, autoClassified, needReview, failed) {
    const percentage = Math.floor((processed / total) * 100);
    const autoPercentage = Math.floor((autoClassified / total) * 100);
    const reviewPercentage = Math.floor((needReview / total) * 100);
    const failedPercentage = Math.floor((failed / total) * 100);
    
    $('#classifyProgressPercent').text(percentage + '%');
    $('#autoClassifiedBar').css('width', autoPercentage + '%');
    $('#manualReviewBar').css('width', reviewPercentage + '%');
    $('#failedClassificationBar').css('width', failedPercentage + '%');
    
    $('#autoCount').text(autoClassified);
    $('#reviewCount').text(needReview);
    $('#failedCount').text(failed);
}

function updateCategoryStats() {
    const stats = [
        {category: '化学药品', count: 450, percentage: 38.1},
        {category: '二类医疗器械', count: 320, percentage: 27.1},
        {category: '一类医疗器械', count: 240, percentage: 20.3},
        {category: '生物制品', count: 120, percentage: 10.2},
        {category: '其他', count: 50, percentage: 4.2}
    ];
    
    let statsHtml = '';
    stats.forEach(function(stat) {
        statsHtml += `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="small">${stat.category}</span>
                <div>
                    <span class="badge bg-primary">${stat.count}</span>
                    <span class="small text-muted">(${stat.percentage}%)</span>
                </div>
            </div>
        `;
    });
    
    $('#categoryStats').html(statsHtml);
}

// 统计模态框功能
function showStatsModal(type) {
    let title, data;
    
    switch(type) {
        case 'total':
            title = '总记录数详情';
            data = generateTotalData();
            break;
        case 'extracted':
            title = '已提取参数详情';
            data = generateExtractedData();
            break;
        case 'classified':
            title = '已分类详情';
            data = generateClassifiedData();
            break;
        case 'manual':
            title = '需人工确认详情';
            data = generateManualData();
            break;
        default:
            return;
    }
    
    $('#modalTitle').text(title);
    displayStatsData(data);
    
    // 使用Bootstrap 5原生API显示模态框
    const modalElement = document.getElementById('statsModal');
    
    // 移除可能存在的旧实例
    const existingModal = bootstrap.Modal.getInstance(modalElement);
    if (existingModal) {
        existingModal.dispose();
    }
    
    // 创建新的模态框实例
    const modal = new bootstrap.Modal(modalElement, {
        backdrop: false,  // 禁用backdrop避免交互问题
        keyboard: true,
        focus: true
    });
    
    // 手动添加backdrop并确保不影响交互
    let customBackdrop = document.querySelector('.custom-modal-backdrop');
    if (!customBackdrop) {
        customBackdrop = document.createElement('div');
        customBackdrop.className = 'custom-modal-backdrop';
        customBackdrop.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1055;
            pointer-events: none;
        `;
        document.body.appendChild(customBackdrop);
    }
    
    // 确保模态框内容可以交互
    modalElement.addEventListener('shown.bs.modal', function () {
        modalElement.style.pointerEvents = 'auto';
        modalElement.style.zIndex = '1060';
        
        const modalContent = modalElement.querySelector('.modal-content');
        if (modalContent) {
            modalContent.style.pointerEvents = 'auto';
            modalContent.style.zIndex = '1062';
            modalContent.style.position = 'relative';
            modalContent.style.backgroundColor = 'white';
        }
        
        // 确保所有交互元素都可以点击
        const interactiveElements = modalElement.querySelectorAll('input, button, select, a, .btn');
        interactiveElements.forEach(el => {
            el.style.pointerEvents = 'auto';
            el.style.position = 'relative';
            el.style.zIndex = '1063';
        });
    });
    
    // 监听模态框隐藏事件，清理自定义backdrop
    modalElement.addEventListener('hidden.bs.modal', function () {
        const backdrop = document.querySelector('.custom-modal-backdrop');
        if (backdrop) {
            backdrop.remove();
        }
    });
    
    modal.show();
}

function generateTotalData() {
    const data = [];
    for(let i = 1; i <= 1250; i++) {
        // 模拟不同的状态分布：已处理1180条，待处理63条，错误7条
        let status, remark;
        if (i <= 1180) {
            status = 'processed';
            remark = '处理完成';
        } else if (i <= 1243) {
            status = 'pending';
            remark = '待处理';
        } else {
            status = 'error';
            remark = '处理失败';
        }
        
        // 生成更真实的时间分布
        const hour = 8 + Math.floor((i-1) / 150); // 每小时处理约150条
        const minute = Math.floor(Math.random() * 60);
        const timeStr = '2025-09-21 ' + String(hour % 24).padStart(2, '0') + ':' + String(minute).padStart(2, '0');
        
        data.push({
            id: i,
            name: `物料${String(i).padStart(4, '0')}`,
            spec: `规格型号${i}`,
            status: status,
            time: timeStr,
            remark: remark
        });
    }
    return data;
}

function generateExtractedData() {
    const data = [];
    for(let i = 1; i <= 1180; i++) {
        // 生成更真实的时间分布
        const hour = 8 + Math.floor((i-1) / 140); // 每小时处理约140条
        const minute = Math.floor(Math.random() * 60);
        const timeStr = '2025-09-21 ' + String(hour % 24).padStart(2, '0') + ':' + String(minute).padStart(2, '0');
        
        data.push({
            id: i,
            name: `已提取物料${String(i).padStart(4, '0')}`,
            spec: `规格型号${i}`,
            status: 'processed',
            time: timeStr,
            remark: '参数提取成功'
        });
    }
    return data;
}

function generateClassifiedData() {
    return []; // 暂无已分类数据
}

function generateManualData() {
    const data = [];
    for(let i = 1; i <= 70; i++) {
        // 生成更真实的时间分布
        const hour = 10 + Math.floor((i-1) / 10); // 每小时约10条需要人工确认
        const minute = Math.floor(Math.random() * 60);
        const timeStr = '2025-09-21 ' + String(hour % 24).padStart(2, '0') + ':' + String(minute).padStart(2, '0');
        
        data.push({
            id: i + 1180,
            name: `待确认物料${String(i).padStart(4, '0')}`,
            spec: `复杂规格${i}`,
            status: 'pending',
            time: timeStr,
            remark: '需要人工确认分类'
        });
    }
    return data;
}

let currentStatsData = []; // 全局存储当前数据
let currentPage = 1;
const recordsPerPage = 50;

function displayStatsData(data) {
    currentStatsData = data; // 保存完整数据
    currentPage = 1; // 重置到第一页
    renderStatsPage();
}

function renderStatsPage() {
    const startIndex = (currentPage - 1) * recordsPerPage;
    const endIndex = startIndex + recordsPerPage;
    const pageData = currentStatsData.slice(startIndex, endIndex);
    
    let tableHtml = '';
    
    if (pageData.length === 0) {
        tableHtml = '<tr><td colspan="6" class="text-center text-muted">暂无数据</td></tr>';
    } else {
        pageData.forEach(function(item, index) {
            const statusBadge = item.status === 'processed' ? 'bg-success' : 
                               item.status === 'pending' ? 'bg-warning' : 'bg-danger';
            const statusText = item.status === 'processed' ? '已处理' : 
                              item.status === 'pending' ? '待处理' : '错误';
            
            const globalIndex = startIndex + index + 1;
            
            tableHtml += `
                <tr>
                    <td>${globalIndex}</td>
                    <td>${item.name}</td>
                    <td>${item.spec}</td>
                    <td><span class="badge ${statusBadge}">${statusText}</span></td>
                    <td><small class="text-muted">${item.time}</small></td>
                    <td><small>${item.remark}</small></td>
                </tr>
            `;
        });
    }
    
    $('#statsTableBody').html(tableHtml);
    
    // 生成分页导航
    const totalPages = Math.ceil(currentStatsData.length / recordsPerPage);
    let paginationHtml = '';
    
    // 上一页按钮
    if (currentPage > 1) {
        paginationHtml += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="goToStatsPage(${currentPage - 1}); return false;">上一页</a>
            </li>
        `;
    } else {
        paginationHtml += `
            <li class="page-item disabled">
                <span class="page-link">上一页</span>
            </li>
        `;
    }
    
    // 页码按钮（显示当前页附近的几页）
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="goToStatsPage(1); return false;">1</a></li>`;
        if (startPage > 2) {
            paginationHtml += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        if (i === currentPage) {
            paginationHtml += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
        } else {
            paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="goToStatsPage(${i}); return false;">${i}</a></li>`;
        }
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            paginationHtml += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="goToStatsPage(${totalPages}); return false;">${totalPages}</a></li>`;
    }
    
    // 下一页按钮
    if (currentPage < totalPages) {
        paginationHtml += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="goToStatsPage(${currentPage + 1}); return false;">下一页</a>
            </li>
        `;
    } else {
        paginationHtml += `
            <li class="page-item disabled">
                <span class="page-link">下一页</span>
            </li>
        `;
    }
    
    // 显示记录信息
    paginationHtml += `
        <li class="page-item disabled">
            <span class="page-link">
                显示 ${startIndex + 1}-${Math.min(endIndex, currentStatsData.length)} / 共 ${currentStatsData.length} 条
            </span>
        </li>
    `;
    
    $('#statsPagination').html(paginationHtml);
}

function goToStatsPage(page) {
    currentPage = page;
    renderStatsPage();
}

function downloadStatsData() {
    const modalTitle = $('#modalTitle').text();
    
    if (!currentStatsData || currentStatsData.length === 0) {
        alert('暂无数据可下载');
        return;
    }
    
    // 构建CSV数据 - 使用完整数据集而不是当前页面数据
    let csvContent = '序号,物料名称,规格型号,状态,处理时间,备注\n';
    
    currentStatsData.forEach(function(item, index) {
        const statusText = item.status === 'processed' ? '已处理' : 
                          item.status === 'pending' ? '待处理' : '错误';
        
        const row = [
            `"${index + 1}"`,
            `"${item.name}"`,
            `"${item.spec}"`,
            `"${statusText}"`,
            `"${item.time}"`,
            `"${item.remark}"`
        ];
        csvContent += row.join(',') + '\n';
    });
    
    // 下载CSV文件
    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `${modalTitle}_${new Date().toISOString().slice(0,10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // 显示成功消息
    const originalBtn = event.target.closest('button');
    const originalText = originalBtn.innerHTML;
    originalBtn.innerHTML = '<i class="fas fa-check"></i> 下载成功';
    originalBtn.classList.remove('btn-success');
    originalBtn.classList.add('btn-outline-success');
    
    setTimeout(function() {
        originalBtn.innerHTML = originalText;
        originalBtn.classList.remove('btn-outline-success');
        originalBtn.classList.add('btn-success');
    }, 2000);
}

// 智能推荐相关函数
function selectRecommendation(materialName, categoryId, categoryName) {
    // 选择推荐的分类
    console.log(`选择分类: ${materialName} -> ${categoryName} (${categoryId})`);
    
    // 高亮选中的推荐项
    document.querySelectorAll('.recommendation-option').forEach(option => {
        option.classList.remove('border-success', 'bg-light');
    });
    
    const selectedOption = document.querySelector(`[data-category-id="${categoryId}"]`);
    if (selectedOption) {
        selectedOption.classList.add('border-success', 'bg-light');
    }
    
    // 保存选择结果
    if (!window.selectedCategories) {
        window.selectedCategories = {};
    }
    window.selectedCategories[materialName] = {
        categoryId: categoryId,
        categoryName: categoryName
    };
    
    showSuccessMessage(`已为"${materialName}"选择分类：${categoryName}`);
}

function viewCategoryFeatures(categoryId) {
    // 查看分类特征模型
    console.log(`查看分类特征: ${categoryId}`);
    
    // 显示加载状态
    showLoading('正在获取分类特征...');
    
    // 调用API获取分类特征
    fetch(`/api/category_features/${categoryId}`)
        .then(response => response.json())
        .then(data => {
            hideLoading();
            
            if (data.success) {
                showCategoryFeaturesModal(categoryId, data.features);
            } else {
                showErrorMessage(data.error || '获取分类特征失败');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('获取分类特征失败:', error);
            showErrorMessage('获取分类特征失败，请重试');
        });
}

function showCategoryFeaturesModal(categoryId, features) {
    // 显示分类特征模态框
    let modalHtml = `
        <div class="modal fade" id="categoryFeaturesModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">分类特征模型 - ${categoryId}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>特征名称</th>
                                        <th>数据类型</th>
                                        <th>是否必填</th>
                                        <th>约束条件</th>
                                    </tr>
                                </thead>
                                <tbody>
    `;
    
    features.forEach(feature => {
        let constraintText = '';
        if (feature.max_length) {
            constraintText += `最大长度: ${feature.max_length}`;
        }
        if (feature.options) {
            constraintText += `选项: ${feature.options.join(', ')}`;
        }
        if (feature.pattern) {
            constraintText += `格式: ${feature.pattern}`;
        }
        
        modalHtml += `
            <tr>
                <td><strong>${feature.name}</strong></td>
                <td><span class="badge bg-info">${feature.type}</span></td>
                <td>${feature.required ? '<span class="badge bg-danger">必填</span>' : '<span class="badge bg-secondary">选填</span>'}</td>
                <td class="small">${constraintText}</td>
            </tr>
        `;
    });
    
    modalHtml += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // 移除可能存在的旧模态框
    const existingModal = document.getElementById('categoryFeaturesModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // 添加新模态框并显示
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('categoryFeaturesModal'));
    modal.show();
}

function batchSelectRecommendations() {
    // 批量选择推荐结果
    if (!window.selectedCategories || Object.keys(window.selectedCategories).length === 0) {
        showErrorMessage('请至少选择一个分类推荐');
        return;
    }
    
    const selections = window.selectedCategories;
    
    // 显示确认对话框
    const confirmMessage = `确定要为 ${Object.keys(selections).length} 个物料应用选择的分类吗？`;
    
    if (confirm(confirmMessage)) {
        // 保存分类选择
        saveCategorySelections(selections);
    }
}

function saveCategorySelections(selections) {
    // 保存分类选择到服务器
    showLoading('正在保存分类选择...');
    
    fetch('/category_selection', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            selections: selections
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        
        if (data.success) {
            showSuccessMessage(data.message);
            // 跳转到下一步
            setTimeout(() => {
                window.location.href = data.next_step;
            }, 2000);
        } else {
            showErrorMessage(data.error || '保存失败');
        }
    })
    .catch(error => {
        hideLoading();
        console.error('保存分类选择失败:', error);
        showErrorMessage('保存失败，请重试');
    });
}

// 推荐卡片交互效果
document.addEventListener('DOMContentLoaded', function() {
    // 为推荐选项添加悬停效果
    document.querySelectorAll('.recommendation-option').forEach(option => {
        option.addEventListener('mouseenter', function() {
            if (!this.classList.contains('border-success')) {
                this.classList.add('border-primary', 'shadow-sm');
            }
        });
        
        option.addEventListener('mouseleave', function() {
            if (!this.classList.contains('border-success')) {
                this.classList.remove('border-primary', 'shadow-sm');
            }
        });
    });
});
</script>
{% endblock %}
