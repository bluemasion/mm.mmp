{% extends "base.html" %}

{% block title %}首页 - 物料主数据管理智能应用{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- 欢迎横幅 -->
        <div class="bg-gradient-primary text-white rounded p-5 mb-4">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h1 class="display-4 fw-bold mb-3" style="color: #fff; text-shadow: 0 0 10px #007bff, 0 0 20px #007bff;">物料主数据管理智能应用</h1>
                    <p class="lead mb-0">
                        自动化物料信息提取、智能分类推荐、模糊匹配去重，
                        提升物料主数据标准化水平，降低人工录入成本。
                    </p>
                </div>
                <div class="col-lg-4 text-center">
                    <i class="fas fa-robot fa-5x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 快速开始 -->
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-rocket text-primary"></i> 快速开始
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- 步骤1：数据导入 -->
                    <div class="col-md-6 mb-4">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    <span class="fw-bold">1</span>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="fw-bold">数据导入</h6>
                                <p class="text-muted small mb-2">上传Excel文件或连接数据库，导入待处理的物料数据</p>
                                <a href="{{ url_for('upload_page') }}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-upload"></i> 开始导入
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 步骤2：选择分类模板 -->
                    <div class="col-md-6 mb-4">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    <span class="fw-bold">2</span>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="fw-bold">选择分类模板</h6>
                                <p class="text-muted small mb-2">选择适合的分类体系，如制造业标准分类等</p>
                                <a href="{{ url_for('template_selection') }}" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-tags"></i> 选择模板
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 步骤3：参数提取 -->
                    <div class="col-md-6 mb-4">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <div class="bg-info text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    <span class="fw-bold">3</span>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="fw-bold">参数提取</h6>
                                <p class="text-muted small mb-2">智能分词，提取品牌、规格、型号等关键参数</p>
                                <button class="btn btn-outline-info btn-sm" disabled>
                                    <i class="fas fa-cogs"></i> 自动提取
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 步骤4：分类推荐 -->
                    <div class="col-md-6 mb-4">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <div class="bg-warning text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    <span class="fw-bold">4</span>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="fw-bold">智能分类</h6>
                                <p class="text-muted small mb-2">基于选定模板和提取参数，智能推荐物料分类</p>
                                <button class="btn btn-outline-warning btn-sm" disabled>
                                    <i class="fas fa-robot"></i> 智能分类
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 步骤5：表单生成 -->
                    <div class="col-md-6 mb-4">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    <span class="fw-bold">5</span>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="fw-bold">表单生成</h6>
                                <p class="text-muted small mb-2">根据分类生成动态表单，自动填充已提取的参数</p>
                                <button class="btn btn-outline-success btn-sm" disabled>
                                    <i class="fas fa-wpforms"></i> 生成表单
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 步骤6：模糊匹配 -->
                    <div class="col-md-6 mb-4">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <div class="bg-danger text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    <span class="fw-bold">6</span>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="fw-bold">智能对码</h6>
                                <p class="text-muted small mb-2">与已发布物料数据进行智能匹配，避免重复</p>
                                <button class="btn btn-outline-danger btn-sm" disabled>
                                    <i class="fas fa-search"></i> 执行匹配
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 步骤6：决策确认 -->
                    <div class="col-md-6 mb-4">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <div class="bg-dark text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    <span class="fw-bold">6</span>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="fw-bold">决策确认</h6>
                                <p class="text-muted small mb-2">查看匹配结果，决定新增、更新或废弃</p>
                                <button class="btn btn-outline-dark btn-sm" disabled>
                                    <i class="fas fa-check-circle"></i> 确认决策
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 系统统计 -->
    <div class="col-lg-4">
        <!-- 分类模板状态 -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tags text-secondary"></i> 分类模板
                </h5>
                <a href="{{ url_for('template_selection') }}" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-cog"></i> 管理
                </a>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-gradient-secondary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                        <i class="fas fa-sitemap"></i>
                    </div>
                    <div>
                        <h6 class="mb-1" id="templateName">制造业标准分类</h6>
                        <small class="text-muted" id="templateInfo">3层级结构 · 548个分类</small>
                    </div>
                </div>
                <div class="progress mb-2" style="height: 6px;">
                    <div class="progress-bar bg-secondary" role="progressbar" style="width: 85%" aria-valuenow="85" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <small class="text-muted">模板完整度: 85%</small>
                <div class="mt-3">
                    <div class="d-flex justify-content-between small text-muted mb-1">
                        <span>一级分类</span>
                        <span id="level1Count">18</span>
                    </div>
                    <div class="d-flex justify-content-between small text-muted mb-1">
                        <span>二级分类</span>
                        <span id="level2Count">98</span>
                    </div>
                    <div class="d-flex justify-content-between small text-muted">
                        <span>三级分类</span>
                        <span id="level3Count">432</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar text-success"></i> 系统统计
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="bg-light rounded p-3">
                            <h4 class="text-primary mb-1" id="masterDataCount">--</h4>
                            <small class="text-muted">主数据记录</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="bg-light rounded p-3">
                            <h4 class="text-info mb-1" id="todayProcessed">--</h4>
                            <small class="text-muted">今日处理</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="bg-light rounded p-3">
                            <h4 class="text-warning mb-1" id="pendingReview">--</h4>
                            <small class="text-muted">待审核</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="bg-light rounded p-3">
                            <h4 class="text-success mb-1" id="matchAccuracy">--</h4>
                            <small class="text-muted">匹配准确率</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 功能导航 -->
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-th-large text-info"></i> 功能导航
                </h5>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <a href="{{ url_for('upload_page') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-upload text-primary"></i>
                            <span class="ms-2">数据导入</span>
                        </div>
                        <i class="fas fa-chevron-right text-muted"></i>
                    </a>
                    <a href="{{ url_for('template_selection') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-tags text-secondary"></i>
                            <span class="ms-2">分类模板</span>
                        </div>
                        <i class="fas fa-chevron-right text-muted"></i>
                    </a>
                    <a href="{{ url_for('batch_management') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-tasks text-success"></i>
                            <span class="ms-2">批量管理</span>
                        </div>
                        <i class="fas fa-chevron-right text-muted"></i>
                    </a>
                    <a href="#" onclick="checkSystemStatus(); return false;" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-cog text-warning"></i>
                            <span class="ms-2">系统设置</span>
                        </div>
                        <i class="fas fa-chevron-right text-muted"></i>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-chart-line text-info"></i>
                            <span class="ms-2">统计报告</span>
                        </div>
                        <i class="fas fa-chevron-right text-muted"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 最近处理记录 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history text-secondary"></i> 最近处理记录
                </h5>
                <button class="btn btn-outline-secondary btn-sm" onclick="refreshRecentRecords()">
                    <i class="fas fa-refresh"></i> 刷新
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>处理时间</th>
                                <th>数据来源</th>
                                <th>处理数量</th>
                                <th>匹配成功</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="recentRecordsTable">
                            <tr>
                                <td colspan="6" class="text-center text-muted">
                                    <i class="fas fa-inbox"></i> 暂无处理记录
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // 加载系统统计数据
    loadSystemStats();
    
    // 加载分类模板信息
    loadTemplateInfo();
    
    // 加载最近处理记录
    loadRecentRecords();
});

function loadSystemStats() {
    // 模拟统计数据（实际应该从API获取）
    $('#masterDataCount').text('12,345');
    $('#todayProcessed').text('89');
    $('#pendingReview').text('23');
    $('#matchAccuracy').text('95.2%');
}

function loadTemplateInfo() {
    // 从API获取分类模板统计信息
    $.get('/api/categories/stats')
        .done(function(data) {
            if (data.success) {
                const stats = data.statistics;
                $('#templateName').text('制造业标准分类模板');
                $('#templateInfo').text(`3层级结构 · ${stats.total}个分类`);
                $('#level1Count').text(stats.level1);
                $('#level2Count').text(stats.level2);  
                $('#level3Count').text(stats.level3);
                
                // 计算模板完整度（基于分类数量的百分比）
                const completeness = Math.min(100, (stats.total / 600 * 100));
                $('.progress-bar').css('width', completeness + '%').attr('aria-valuenow', completeness);
                $('.progress').next('small').text(`模板完整度: ${completeness.toFixed(0)}%`);
            }
        })
        .fail(function() {
            // 如果API调用失败，使用默认数据
            $('#templateName').text('制造业标准分类模板');
            $('#templateInfo').text('3层级结构 · 548个分类');
            $('#level1Count').text('18');
            $('#level2Count').text('98');
            $('#level3Count').text('432');
        });
}

function loadRecentRecords() {
    // 模拟最近处理记录（实际应该从API获取）
    const sampleRecords = [
        {
            timestamp: '2024-03-15 14:30:25',
            source: 'Excel导入',
            total: 156,
            matched: 142,
            status: '已完成'
        },
        {
            timestamp: '2024-03-15 10:15:10',
            source: '数据库同步',
            total: 89,
            matched: 85,
            status: '已完成'
        },
        {
            timestamp: '2024-03-14 16:45:30',
            source: 'Excel导入',
            total: 234,
            matched: 201,
            status: '待审核'
        }
    ];
    
    let tableHtml = '';
    sampleRecords.forEach(function(record) {
        let statusClass = record.status === '已完成' ? 'success' : 
                         record.status === '待审核' ? 'warning' : 'secondary';
        
        tableHtml += `
            <tr>
                <td>${record.timestamp}</td>
                <td><i class="fas fa-file-excel text-success"></i> ${record.source}</td>
                <td>${record.total}</td>
                <td>${record.matched} <small class="text-muted">(${(record.matched/record.total*100).toFixed(1)}%)</small></td>
                <td><span class="badge bg-${statusClass}">${record.status}</span></td>
                <td>
                    <button class="btn btn-outline-primary btn-sm" onclick="viewDetails('${record.timestamp}')">
                        <i class="fas fa-eye"></i> 查看
                    </button>
                </td>
            </tr>
        `;
    });
    
    $('#recentRecordsTable').html(tableHtml);
}

function refreshRecentRecords() {
    showLoading('正在刷新记录...');
    setTimeout(function() {
        loadRecentRecords();
        hideLoading();
        showSuccessMessage('记录已刷新');
    }, 1000);
}

function viewDetails(timestamp) {
    alert('查看详情功能开发中：' + timestamp);
}
</script>
{% endblock %}
