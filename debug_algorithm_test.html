<!DOCTYPE html>
<html>
<head>
    <title>ç®—æ³•æµ‹è¯•è°ƒè¯•</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .result { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 3px; }
        .error { background: #ffeaea; color: #d00; }
        .success { background: #eaffea; color: #0a0; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ”¬ MMPç®—æ³•æµ‹è¯•è°ƒè¯•é¡µé¢</h1>
    
    <div class="test-section">
        <h3>æµ‹è¯•1: ç›´æ¥APIè°ƒç”¨</h3>
        <button onclick="testAPI()">æµ‹è¯•æ‰¹é‡åŒ¹é…API</button>
        <div id="apiResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>æµ‹è¯•2: æ¨¡æ‹Ÿå·¥ä½œæµæ•°æ®</h3>
        <button onclick="testWorkflowData()">æµ‹è¯•å·¥ä½œæµæ•°æ®å¤„ç†</button>
        <div id="workflowResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>æµ‹è¯•3: æ•°æ®æ ¼å¼éªŒè¯</h3>
        <button onclick="testDataFormat()">éªŒè¯æ•°æ®æ ¼å¼</button>
        <div id="formatResult" class="result"></div>
    </div>

    <script>
        async function testAPI() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = 'æ­£åœ¨æµ‹è¯•...';
            
            try {
                const testData = {
                    "materials": [
                        ["M001", "304ä¸é”ˆé’¢ç–æ°´å™¨", "ç–æ°´å™¨", "ç®¡é“é…ä»¶", "DN25", "", "ä¸ª"],
                        ["M002", "ç¢³é’¢èºå¡", "èºå¡", "ç´§å›ºä»¶", "M8", "", "ä¸ª"],
                        ["M003", "æ³•å…°ç›˜", "æ³•å…°", "ç®¡é“é…ä»¶", "DN100", "", "ä¸ª"]
                    ],
                    "template": "universal-manufacturing"
                };
                
                console.log('å‘é€æ•°æ®:', testData);
                
                const response = await fetch('/api/batch_material_matching', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                const result = await response.json();
                console.log('APIå“åº”:', result);
                
                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>APIå“åº”æˆåŠŸ!</h4>
                        <p><strong>çŠ¶æ€:</strong> ${result.success ? 'æˆåŠŸ' : 'å¤±è´¥'}</p>
                        <p><strong>ç»“æœæ•°é‡:</strong> ${result.results ? result.results.length : 0}</p>
                        <p><strong>æ€»è®¡:</strong> ${result.total || 0}</p>
                        <p><strong>æ¨¡æ¿:</strong> ${result.template || 'æœªçŸ¥'}</p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                console.error('APIé”™è¯¯:', error);
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>APIè°ƒç”¨å¤±è´¥!</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function testWorkflowData() {
            const resultDiv = document.getElementById('workflowResult');
            resultDiv.innerHTML = 'æ­£åœ¨æ¨¡æ‹Ÿå·¥ä½œæµ...';
            
            // æ¨¡æ‹Ÿå·¥ä½œæµå¤„ç†
            const mockUploadedData = [
                ["M001", "304ä¸é”ˆé’¢ç–æ°´å™¨", "ç–æ°´å™¨", "ç®¡é“é…ä»¶", "DN25", "", "ä¸ª"]
            ];
            
            const mockSelectedTemplate = "universal-manufacturing";
            
            try {
                const response = await fetch('/api/batch_material_matching', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        materials: mockUploadedData,
                        template: mockSelectedTemplate
                    })
                });
                
                const result = await response.json();
                
                // æ¨¡æ‹Ÿ displayResults() é€»è¾‘
                let matchingResults = result.results;
                let displayHTML = '';
                
                if (!matchingResults || matchingResults.length === 0) {
                    displayHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <h5 style="color: #6c757d;">æš‚æ— åŒ¹é…ç»“æœ</h5>
                        </div>
                    `;
                } else {
                    displayHTML = `
                        <table border="1" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #343a40; color: white;">
                                    <th>ç‰©æ–™åç§°</th>
                                    <th>è§„æ ¼</th>
                                    <th>åˆ†ç±»ç»“æœ</th>
                                    <th>ç½®ä¿¡åº¦</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${matchingResults.map(result => `
                                    <tr>
                                        <td>${result.material_name || 'æœªçŸ¥ç‰©æ–™'}</td>
                                        <td>${result.material_spec || 'æ— è§„æ ¼ä¿¡æ¯'}</td>
                                        <td>${result.classification || 'æœªåˆ†ç±»'}</td>
                                        <td>${result.classification_confidence || 0}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
                
                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>å·¥ä½œæµæ¨¡æ‹Ÿç»“æœ:</h4>
                        <p><strong>åŒ¹é…ç»“æœæ•°é‡:</strong> ${matchingResults ? matchingResults.length : 0}</p>
                        <p><strong>æ˜¾ç¤ºå†…å®¹:</strong></p>
                        ${displayHTML}
                    </div>
                `;
                
            } catch (error) {
                console.error('å·¥ä½œæµé”™è¯¯:', error);
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>å·¥ä½œæµæ¨¡æ‹Ÿå¤±è´¥!</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        function testDataFormat() {
            const resultDiv = document.getElementById('formatResult');
            
            // æµ‹è¯•å„ç§æ•°æ®æ ¼å¼
            const testCases = [
                {
                    name: "æ­£å¸¸æ ¼å¼",
                    data: [["M001", "304ä¸é”ˆé’¢ç–æ°´å™¨", "ç–æ°´å™¨", "ç®¡é“é…ä»¶", "DN25", "", "ä¸ª"]],
                    valid: true
                },
                {
                    name: "ç¼ºå°‘å­—æ®µ",
                    data: [["M001", "304ä¸é”ˆé’¢ç–æ°´å™¨"]],
                    valid: false
                },
                {
                    name: "ç©ºæ•°ç»„",
                    data: [],
                    valid: false
                },
                {
                    name: "åŒ…å«ç©ºå€¼",
                    data: [["", "", "", "", "", "", ""]],
                    valid: false
                }
            ];
            
            let formatHTML = '<ul>';
            testCases.forEach(testCase => {
                formatHTML += `
                    <li>
                        <strong>${testCase.name}:</strong> 
                        ${testCase.valid ? 'âœ… æœ‰æ•ˆ' : 'âŒ æ— æ•ˆ'}
                        <br><code>${JSON.stringify(testCase.data)}</code>
                    </li>
                `;
            });
            formatHTML += '</ul>';
            
            resultDiv.innerHTML = `
                <div>
                    <h4>æ•°æ®æ ¼å¼éªŒè¯ç»“æœ:</h4>
                    ${formatHTML}
                </div>
            `;
        }
    </script>
</body>
</html>