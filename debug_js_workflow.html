<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>MMP JavaScriptè°ƒè¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .result { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 3px; }
        .error { background: #ffeaea; color: #d00; }
        .success { background: #eaffea; color: #0a0; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>ğŸ” MMP JavaScriptè°ƒè¯•å·¥å…·</h1>
    
    <div class="test-section">
        <h3>æµ‹è¯•1: åŸºç¡€JavaScriptåŠŸèƒ½</h3>
        <button onclick="testBasicJS()">æµ‹è¯•åŸºç¡€JS</button>
        <div id="basicResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>æµ‹è¯•2: è‡ªå®šä¹‰äº‹ä»¶æœºåˆ¶</h3>
        <button onclick="testCustomEvents()">æµ‹è¯•äº‹ä»¶æœºåˆ¶</button>
        <div id="eventResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>æµ‹è¯•3: APIè°ƒç”¨</h3>
        <button onclick="testAPICall()">æµ‹è¯•APIè°ƒç”¨</button>
        <div id="apiResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>æµ‹è¯•4: æ¨¡æ‹Ÿå·¥ä½œæµåŒ¹é…</h3>
        <button onclick="testWorkflowMatching()">æ¨¡æ‹ŸåŒ¹é…æµç¨‹</button>
        <div id="workflowResult" class="result"></div>
    </div>

    <script>
        function testBasicJS() {
            const resultDiv = document.getElementById('basicResult');
            try {
                // æµ‹è¯•åŸºç¡€JavaScriptåŠŸèƒ½
                const testArray = [1, 2, 3];
                const testObj = { test: true };
                const testDate = new Date();
                
                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>âœ… åŸºç¡€JavaScriptæ­£å¸¸</h4>
                        <p>æ•°ç»„: ${JSON.stringify(testArray)}</p>
                        <p>å¯¹è±¡: ${JSON.stringify(testObj)}</p>
                        <p>æ—¶é—´: ${testDate.toISOString()}</p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>âŒ JavaScripté”™è¯¯</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        function testCustomEvents() {
            const resultDiv = document.getElementById('eventResult');
            try {
                // æµ‹è¯•è‡ªå®šä¹‰äº‹ä»¶
                const handleTestEvent = (event) => {
                    const { message, count } = event.detail;
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>âœ… è‡ªå®šä¹‰äº‹ä»¶æ­£å¸¸</h4>
                            <p>æ¶ˆæ¯: ${message}</p>
                            <p>æ•°é‡: ${count}</p>
                        </div>
                    `;
                    window.removeEventListener('testEvent', handleTestEvent);
                };
                
                window.addEventListener('testEvent', handleTestEvent);
                
                // è§¦å‘äº‹ä»¶
                const event = new CustomEvent('testEvent', {
                    detail: { 
                        message: "æµ‹è¯•æˆåŠŸ",
                        count: 42 
                    }
                });
                window.dispatchEvent(event);
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>âŒ äº‹ä»¶æœºåˆ¶é”™è¯¯</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function testAPICall() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = '<p>æ­£åœ¨æµ‹è¯•APIè°ƒç”¨...</p>';
            
            try {
                const testData = {
                    "materials": [["TEST", "æµ‹è¯•ç‰©æ–™", "æµ‹è¯•", "æµ‹è¯•åˆ†ç±»", "TEST", "", "ä¸ª"]],
                    "template": "universal-manufacturing"
                };
                
                console.log('å‘é€APIè¯·æ±‚:', testData);
                
                const startTime = Date.now();
                const response = await fetch('/api/batch_material_matching', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                const responseTime = Date.now() - startTime;
                const result = await response.json();
                
                console.log('APIå“åº”:', result);
                
                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>âœ… APIè°ƒç”¨æˆåŠŸ</h4>
                        <p>å“åº”æ—¶é—´: ${responseTime}ms</p>
                        <p>çŠ¶æ€: ${result.success ? 'æˆåŠŸ' : 'å¤±è´¥'}</p>
                        <p>ç»“æœæ•°é‡: ${result.results ? result.results.length : 0}</p>
                        <p>æ€»è®¡: ${result.total || 0}</p>
                        <pre style="max-height: 200px; overflow: auto;">${JSON.stringify(result, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                console.error('APIè°ƒç”¨é”™è¯¯:', error);
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>âŒ APIè°ƒç”¨å¤±è´¥</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function testWorkflowMatching() {
            const resultDiv = document.getElementById('workflowResult');
            resultDiv.innerHTML = '<p>æ­£åœ¨æ¨¡æ‹Ÿå·¥ä½œæµåŒ¹é…...</p>';
            
            try {
                // æ¨¡æ‹Ÿå·¥ä½œæµæ•°æ®
                const mockUploadedData = [
                    ["M001", "304ä¸é”ˆé’¢ç–æ°´å™¨", "ç–æ°´å™¨", "ç®¡é“é…ä»¶", "DN25", "", "ä¸ª"],
                    ["M002", "ç¢³é’¢èºå¡", "èºå¡", "ç´§å›ºä»¶", "M8", "", "ä¸ª"]
                ];
                const mockSelectedTemplate = "universal-manufacturing";
                
                console.log(`æ¨¡æ‹ŸåŒ¹é…: ${mockUploadedData.length}æ¡æ•°æ®, æ¨¡æ¿: ${mockSelectedTemplate}`);
                
                // æ¨¡æ‹ŸåŒ¹é…å®Œæˆäº‹ä»¶
                let eventReceived = false;
                const handleMatchingComplete = (event) => {
                    eventReceived = true;
                    const { results, count, error } = event.detail;
                    
                    if (error) {
                        resultDiv.innerHTML = `
                            <div class="error">
                                <h4>âŒ åŒ¹é…å¤±è´¥</h4>
                                <p>${error}</p>
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="success">
                                <h4>âœ… å·¥ä½œæµåŒ¹é…æ¨¡æ‹ŸæˆåŠŸ</h4>
                                <p>å¤„ç†æ•°é‡: ${count}æ¡</p>
                                <p>äº‹ä»¶æœºåˆ¶: æ­£å¸¸å·¥ä½œ</p>
                            </div>
                        `;
                    }
                    window.removeEventListener('matchingComplete', handleMatchingComplete);
                };
                
                window.addEventListener('matchingComplete', handleMatchingComplete);
                
                // å‘é€APIè¯·æ±‚
                const response = await fetch('/api/batch_material_matching', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        materials: mockUploadedData,
                        template: mockSelectedTemplate
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // è§¦å‘åŒ¹é…å®Œæˆäº‹ä»¶
                    const event = new CustomEvent('matchingComplete', {
                        detail: { 
                            results: result.results,
                            count: result.results.length 
                        }
                    });
                    window.dispatchEvent(event);
                } else {
                    const event = new CustomEvent('matchingComplete', {
                        detail: { 
                            results: [],
                            count: 0,
                            error: result.error 
                        }
                    });
                    window.dispatchEvent(event);
                }
                
                // æ£€æŸ¥äº‹ä»¶æ˜¯å¦è¢«æ¥æ”¶
                setTimeout(() => {
                    if (!eventReceived) {
                        resultDiv.innerHTML = `
                            <div class="error">
                                <h4>âŒ äº‹ä»¶æœªæ¥æ”¶</h4>
                                <p>APIè°ƒç”¨æˆåŠŸä½†äº‹ä»¶æœºåˆ¶æœ‰é—®é¢˜</p>
                            </div>
                        `;
                    }
                }, 1000);
                
            } catch (error) {
                console.error('å·¥ä½œæµæµ‹è¯•é”™è¯¯:', error);
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>âŒ å·¥ä½œæµæµ‹è¯•å¤±è´¥</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è¾“å‡ºè°ƒè¯•ä¿¡æ¯
        window.addEventListener('load', function() {
            console.log('MMP JavaScriptè°ƒè¯•å·¥å…·å·²åŠ è½½');
            console.log('å½“å‰URL:', window.location.href);
            console.log('æµè§ˆå™¨:', navigator.userAgent);
        });
        
        // æ•è·æœªå¤„ç†çš„é”™è¯¯
        window.addEventListener('error', function(event) {
            console.error('JavaScripté”™è¯¯:', event.error);
            console.error('é”™è¯¯ä½ç½®:', event.filename, ':', event.lineno);
        });
    </script>
</body>
</html>