--- app/web_app.py.orig	2024-01-01 00:00:00.000000000 +0800
+++ app/web_app.py	2024-01-01 00:00:00.000000000 +0800
@@ -34,7 +34,16 @@
 # 创建Flask应用，指定正确的模板和静态文件路径
 app = Flask(__name__, 
            template_folder=os.path.join(project_root, 'templates'),
            static_folder=os.path.join(project_root, 'static'))
-app.secret_key = 'your-secret-key-change-in-production'
+
+# 配置Flask会话
+app.secret_key = 'your-secret-key-change-in-production'
+app.config['SESSION_TYPE'] = 'filesystem'
+app.config['SESSION_PERMANENT'] = False
+app.config['SESSION_USE_SIGNER'] = True
+app.config['SESSION_KEY_PREFIX'] = 'mmp_session:'
+app.config['SESSION_COOKIE_HTTPONLY'] = True
+app.config['SESSION_COOKIE_SECURE'] = False  # 开发环境设为False，生产环境应为True
+app.config['PERMANENT_SESSION_LIFETIME'] = 3600  # 1小时过期
 
 # 配置文件上传
 UPLOAD_FOLDER = 'uploads'
@@ -49,7 +58,12 @@
 
 # 全局服务实例
 workflow_service = None
-session_data = {}  # 简单的会话数据存储
+
+# 增强的会话数据存储 - 使用Flask session而不是全局字典
+def get_session_storage():
+    """获取会话存储字典"""
+    if 'mmp_data' not in session:
+        session['mmp_data'] = {}
+    return session['mmp_data']
 
 def init_service():
     """初始化工作流服务"""
@@ -81,19 +95,29 @@
     return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS
 
-def get_session_id():
-    """获取或创建会话ID"""
-    if 'session_id' not in session:
-        session['session_id'] = str(uuid.uuid4())
-    return session['session_id']
-
 def store_session_data(key: str, data: Any):
-    """存储会话数据"""
-    session_id = get_session_id()
-    if session_id not in session_data:
-        session_data[session_id] = {}
-    session_data[session_id][key] = data
+    """存储会话数据到Flask session"""
+    try:
+        storage = get_session_storage()
+        storage[key] = data
+        session.permanent = True  # 确保session被保存
+        logging.info(f"存储会话数据: {key}, 数据长度: {len(str(data)) if data else 0}")
+        return True
+    except Exception as e:
+        logging.error(f"存储会话数据失败 {key}: {e}")
+        return False
 
 def get_session_data(key: str, default=None):
-    """获取会话数据"""
-    session_id = get_session_id()
-    return session_data.get(session_id, {}).get(key, default)
+    """从Flask session获取会话数据"""
+    try:
+        storage = get_session_storage()
+        data = storage.get(key, default)
+        logging.info(f"获取会话数据: {key}, 是否存在: {data is not None}, 数据长度: {len(str(data)) if data else 0}")
+        return data
+    except Exception as e:
+        logging.error(f"获取会话数据失败 {key}: {e}")
+        return default
+
+def clear_session_data():
+    """清除所有会话数据"""
+    session.pop('mmp_data', None)
+    logging.info("已清除所有会话数据")
